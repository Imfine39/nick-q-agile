#!/bin/bash
#
# post-commit hook - Auto-complete tasks from commit messages
#
# This hook extracts task IDs from commit messages and marks them as completed.
# Task IDs follow the pattern [T-XXX] (e.g., [T-001], [T-010]).
#
# Installation:
#   ln -sf ../../.claude/skills/nick-q/scripts/hooks/post-commit .git/hooks/post-commit
#   chmod +x .git/hooks/post-commit
#
# Or use the setup script:
#   node .claude/skills/nick-q/scripts/setup-hooks.cjs
#

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
REPO_ROOT="$(git rev-parse --show-toplevel)"
TASK_COMPLETE="$REPO_ROOT/.claude/skills/nick-q/scripts/task-complete.cjs"

# Get the last commit message
COMMIT_MSG=$(git log -1 --pretty=%B)

# Extract task IDs (pattern: [T-XXX])
TASK_IDS=$(echo "$COMMIT_MSG" | grep -oE '\[T-[0-9]+\]' | tr -d '[]')

# Exit if no task IDs found
if [ -z "$TASK_IDS" ]; then
  exit 0
fi

# Check if task-complete.cjs exists
if [ ! -f "$TASK_COMPLETE" ]; then
  echo "Warning: task-complete.cjs not found at $TASK_COMPLETE"
  exit 0
fi

# Mark each task as completed
echo ""
echo "=== Auto-completing tasks from commit message ==="
for TASK_ID in $TASK_IDS; do
  echo "Completing: $TASK_ID"
  node "$TASK_COMPLETE" complete "$TASK_ID" 2>/dev/null || true
done
echo "================================================="
echo ""
