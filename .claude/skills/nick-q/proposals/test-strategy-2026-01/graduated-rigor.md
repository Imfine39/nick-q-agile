# Graduated Rigor Model

Status: **Proposal**
Created: 2026-01-06

---

## 1. 概要

### 1.1 コンセプト

```
┌─────────────────────────────────────────────────────────────────────┐
│ 原則: すべての機能に同じレベルの厳格さは不要                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 【現状の問題】                                                       │
│ • すべての機能に同じテンプレート/分析を要求                         │
│ • MVP にも決済機能にも同じ厳格さ → 非効率                          │
│ • 結果: 形骸化 or 過剰な負荷                                        │
│                                                                      │
│ 【提案】                                                             │
│ • リスクに応じて厳格さを段階的に調整                                │
│ • 3段階の Rigor Level を定義                                        │
│ • Level に応じた分析/テスト要件                                     │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2 80/20 の法則

```
「20% の重要機能に 80% の分析リソースを投入」

┌─────────────────────────────────────────────────────────────────────┐
│                                                                      │
│  Level 3 (厳格)     ████████████████████████████████  80% of effort │
│  ~20% of features                                                    │
│                                                                      │
│  Level 2 (標準)     ████████████  20% of effort                     │
│  ~60% of features                                                    │
│                                                                      │
│  Level 1 (最小)     ██  ~0% additional effort                       │
│  ~20% of features                                                    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. Level 定義

### 2.1 Level 1: Minimal

```
┌─────────────────────────────────────────────────────────────────────┐
│ Level 1: Minimal（探索的・MVP）                                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 対象:                                                                │
│ • MVP / プロトタイプ                                                │
│ • 実験的機能（A/Bテスト対象）                                       │
│ • 内部ツール（限定ユーザー）                                        │
│ • 短期間で廃止予定の機能                                            │
│                                                                      │
│ 分析要件:                                                            │
│ • QA: 基本確認のみ（5-10 問）                                        │
│ • パターン分析: なし                                                │
│ • ドキュメント: 最小限                                              │
│                                                                      │
│ テスト要件:                                                          │
│ • ユニットテスト: ハッピーパスのみ                                  │
│ • 統合テスト: 主要フローのみ                                        │
│ • E2E: スモークテストレベル                                         │
│ • カバレッジ目標: なし（品質より速度優先）                          │
│                                                                      │
│ テストケース数目安: 5-10                                            │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 Level 2: Standard

```
┌─────────────────────────────────────────────────────────────────────┐
│ Level 2: Standard（通常の機能）                                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 対象:                                                                │
│ • 正式リリース機能                                                  │
│ • ユーザー向け機能（一般的なもの）                                  │
│ • CRUD 操作                                                          │
│ • 表示/検索機能                                                     │
│                                                                      │
│ 分析要件:                                                            │
│ • QA: 詳細確認（10-20 問）                                           │
│ • パターン分析:                                                      │
│   - 境界値リスト（必須）                                            │
│   - 主要パターン 5-10 個                                            │
│                                                                      │
│ テスト要件:                                                          │
│ • ユニットテスト: ハッピーパス + 主要異常系                         │
│ • 統合テスト: 主要フロー + エッジケース                             │
│ • E2E: 主要ユースケース                                             │
│ • カバレッジ目標: 70%（ステートメント）                             │
│                                                                      │
│ テストケース数目安: 15-30                                           │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.3 Level 3: Rigorous

```
┌─────────────────────────────────────────────────────────────────────┐
│ Level 3: Rigorous（高リスク機能）                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 対象:                                                                │
│ • 決済/課金機能                                                      │
│ • 認証/認可機能                                                      │
│ • 個人情報/機密データ処理                                           │
│ • コアビジネスロジック                                              │
│ • 法的/コンプライアンス要件がある機能                               │
│ • 障害時の影響が大きい機能                                          │
│                                                                      │
│ 分析要件:                                                            │
│ • QA: 包括的確認（20+ 問）                                           │
│ • パターン分析:                                                      │
│   - ディシジョンテーブル（必須）                                    │
│   - 状態遷移図（状態がある場合）                                    │
│   - 同値分割（必須）                                                │
│   - 境界値分析（詳細）                                              │
│                                                                      │
│ テスト要件:                                                          │
│ • ユニットテスト: 全パス網羅                                        │
│ • 統合テスト: 全組み合わせ                                          │
│ • E2E: 全ユースケース + エッジケース                                │
│ • セキュリティテスト: 必須                                          │
│ • カバレッジ目標: 90%（ステートメント）, 80%（ブランチ）            │
│                                                                      │
│ テストケース数目安: 30-50+                                          │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. Level 判定基準

### 3.1 判定マトリックス

```
┌──────────────────────────┬─────────┬──────────┬──────────┐
│ 判定項目                  │ Level 1 │ Level 2  │ Level 3  │
├──────────────────────────┼─────────┼──────────┼──────────┤
│ ビジネスインパクト        │ 低      │ 中       │ 高       │
│ 金銭的影響                │ なし    │ 間接的   │ 直接的   │
│ ユーザー影響範囲          │ 限定的  │ 一部     │ 全体     │
│ セキュリティリスク        │ 低      │ 中       │ 高       │
│ 法的/コンプライアンス要件 │ なし    │ 軽微     │ 重要     │
│ データの機密性            │ 公開可  │ 内部     │ 機密     │
├──────────────────────────┼─────────┼──────────┼──────────┤
│ 条件分岐数                │ 1-3     │ 4-7      │ 8+       │
│ 状態数                    │ 1-2     │ 3-4      │ 5+       │
│ 外部連携数                │ 0       │ 1-2      │ 3+       │
│ トランザクション複雑度    │ 単純    │ 普通     │ 複雑     │
├──────────────────────────┼─────────┼──────────┼──────────┤
│ 変更頻度（予想）          │ 高      │ 中       │ 低       │
│ 寿命（予想）              │ 短期    │ 中期     │ 長期     │
│ リリース形態              │ 実験的  │ 正式     │ コア     │
└──────────────────────────┴─────────┴──────────┴──────────┘

判定ルール:
• Level 3 条件が 1 つでも該当 → Level 3
• Level 1 条件がすべて該当 → Level 1
• それ以外 → Level 2
```

### 3.2 自動判定スクリプト

```javascript
// scripts/determine-rigor.cjs

function determineRigorLevel(featureSpec) {
  // Level 3 条件（1つでも該当すれば Level 3）
  const level3Conditions = [
    featureSpec.involves_payment,
    featureSpec.involves_auth,
    featureSpec.handles_sensitive_data,
    featureSpec.has_compliance_requirements,
    featureSpec.condition_count >= 8,
    featureSpec.state_count >= 5,
    featureSpec.external_integrations >= 3,
  ];

  if (level3Conditions.some(c => c === true)) {
    return 3;
  }

  // Level 1 条件（すべて該当すれば Level 1）
  const level1Conditions = [
    featureSpec.is_mvp || featureSpec.is_prototype,
    featureSpec.is_experimental,
    featureSpec.user_scope === 'limited',
    featureSpec.expected_lifespan === 'short',
  ];

  if (level1Conditions.every(c => c === true)) {
    return 1;
  }

  // デフォルト
  return 2;
}
```

### 3.3 判定フローチャート

```
                          START
                            │
                            ▼
            ┌───────────────────────────────┐
            │ 決済/課金に関わるか？          │
            └───────────────┬───────────────┘
                 Yes ───────┼───────────────────────────→ Level 3
                            │ No
                            ▼
            ┌───────────────────────────────┐
            │ 認証/認可に関わるか？          │
            └───────────────┬───────────────┘
                 Yes ───────┼───────────────────────────→ Level 3
                            │ No
                            ▼
            ┌───────────────────────────────┐
            │ 機密データを扱うか？           │
            └───────────────┬───────────────┘
                 Yes ───────┼───────────────────────────→ Level 3
                            │ No
                            ▼
            ┌───────────────────────────────┐
            │ 法的要件があるか？             │
            └───────────────┬───────────────┘
                 Yes ───────┼───────────────────────────→ Level 3
                            │ No
                            ▼
            ┌───────────────────────────────┐
            │ 条件分岐 8 個以上か？          │
            └───────────────┬───────────────┘
                 Yes ───────┼───────────────────────────→ Level 3
                            │ No
                            ▼
            ┌───────────────────────────────┐
            │ 状態 5 個以上か？              │
            └───────────────┬───────────────┘
                 Yes ───────┼───────────────────────────→ Level 3
                            │ No
                            ▼
            ┌───────────────────────────────┐
            │ MVP/プロトタイプ/実験的か？    │
            └───────────────┬───────────────┘
                 Yes ───────┼───────────────────────────→ Level 1
                            │ No
                            ▼
                         Level 2
```

---

## 4. Level 別の成果物

### 4.1 成果物マトリックス

```
┌─────────────────────────────┬─────────┬─────────┬─────────┐
│ 成果物                       │ Level 1 │ Level 2 │ Level 3 │
├─────────────────────────────┼─────────┼─────────┼─────────┤
│ Feature Spec                │ 簡易版  │ 標準版  │ 詳細版  │
│ QA ドキュメント             │ 5-10問  │ 10-20問 │ 20+問   │
│ 境界値リスト                │ -       │ ✓       │ ✓       │
│ 主要パターン                │ -       │ ✓       │ ✓       │
│ ディシジョンテーブル        │ -       │ -       │ ✓       │
│ 状態遷移図                  │ -       │ -       │ ✓(条件) │
│ 同値分割                    │ -       │ -       │ ✓       │
├─────────────────────────────┼─────────┼─────────┼─────────┤
│ Plan                        │ 簡易版  │ 標準版  │ 詳細版  │
│ テストアプローチ            │ 概要    │ 詳細    │ 包括的  │
│ タスク分割                  │ 粗い    │ 標準    │ 細かい  │
├─────────────────────────────┼─────────┼─────────┼─────────┤
│ ユニットテスト              │ 最小限  │ 標準    │ 網羅的  │
│ 統合テスト                  │ 最小限  │ 標準    │ 網羅的  │
│ E2E テスト                  │ スモーク│ 主要    │ 全ケース│
│ セキュリティテスト          │ -       │ 基本    │ 詳細    │
│ パフォーマンステスト        │ -       │ -       │ 基本    │
├─────────────────────────────┼─────────┼─────────┼─────────┤
│ カバレッジ（ステートメント）│ -       │ 70%     │ 90%     │
│ カバレッジ（ブランチ）      │ -       │ -       │ 80%     │
└─────────────────────────────┴─────────┴─────────┴─────────┘
```

### 4.2 レビュー要件

```
┌─────────────────────────────┬─────────┬─────────┬─────────┐
│ レビュー                     │ Level 1 │ Level 2 │ Level 3 │
├─────────────────────────────┼─────────┼─────────┼─────────┤
│ Spec Multi-Review           │ 1観点   │ 3観点   │ 3観点   │
│ Plan Review                 │ 簡易    │ 標準    │ 詳細    │
│ Code Review                 │ 簡易    │ 標準    │ 詳細    │
│ Security Review             │ -       │ -       │ ✓       │
│ Human Checkpoint            │ 最終のみ│ 標準    │ 全ステップ│
└─────────────────────────────┴─────────┴─────────┴─────────┘
```

---

## 5. Level の変更

### 5.1 昇格（Level Up）

```
トリガー:
• 実験的機能が正式リリースに
• バグが頻発した機能
• ビジネス重要度が上がった機能
• セキュリティ要件が追加された

プロセス:
1. 昇格理由を記録
2. 新しい Level の要件を満たすよう追加分析
3. テストケースを追加
4. ドキュメントを更新
```

### 5.2 降格（Level Down）

```
トリガー:
• 機能が廃止予定に
• 使用頻度が著しく低下
• メンテナンスモードに移行

プロセス:
1. 降格理由を記録
2. 既存のテスト/ドキュメントは維持（削除しない）
3. 新規追加分のみ新 Level 適用

注意:
• Level 3 から降格は慎重に（セキュリティリスク）
• 降格理由は必ず記録
```

---

## 6. Feature Spec への統合

### 6.1 Metadata セクション

```markdown
## Metadata

- Feature ID: F001
- Title: ユーザー認証機能
- Rigor Level: 3
- Level 判定理由: 認証機能のため
- Status: draft
```

### 6.2 Rigor Level セクション

```markdown
## Rigor Level

Level: **3 (Rigorous)**

### 判定根拠

| 条件 | 該当 | 説明 |
|------|------|------|
| 決済/課金 | No | - |
| 認証/認可 | **Yes** | ログイン/ログアウト機能 |
| 機密データ | **Yes** | パスワードハッシュ |
| 法的要件 | No | - |
| 条件分岐 8+ | No | 5 |
| 状態 5+ | No | 3 |

### 要求される成果物

- [ ] QA ドキュメント（20+ 問）
- [ ] ディシジョンテーブル
- [ ] 状態遷移図
- [ ] 同値分割
- [ ] ユニットテスト（90% カバレッジ）
- [ ] セキュリティテスト
```

---

## 7. 運用ガイドライン

### 7.1 Level 判定のタイミング

```
1. Feature Spec 作成開始時に仮判定
2. QA 完了時に確定
3. 必要に応じて Plan/Implement 中に再判定
```

### 7.2 曖昧なケースの扱い

```
判断に迷う場合:
• 高い方の Level を選択（安全側に倒す）
• ただし過剰にならないよう注意
• チームで議論が必要な場合は [NEEDS CLARIFICATION]
```

### 7.3 Level 間の移行

```
Level 変更時は:
1. 変更理由を Feature Spec に記録
2. 差分の成果物を作成
3. テストケースを追加/調整
4. レビューを再実施（昇格の場合）
```

---

## 8. 実装計画

### Phase 1: 定義の確定

```
• Level 定義の最終化
• 判定基準の確定
• テンプレートへの反映
```

### Phase 2: ツール対応

```
• determine-rigor.cjs 作成
• spec-lint への Level 検証追加
• scaffold-spec への Level オプション追加
```

### Phase 3: ワークフロー統合

```
• QA ワークフローへの Level 判定追加
• Feature ワークフローへの統合
• Multi-Review の Level 対応
```

---

## Changelog

| Date | Version | Change |
|------|---------|--------|
| 2026-01-06 | 1.0.0 | Initial proposal |
