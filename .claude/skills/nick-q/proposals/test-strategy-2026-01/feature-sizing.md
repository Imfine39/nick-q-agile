# Feature Sizing Guidelines

Feature の粒度を適切に設計するためのガイドライン。

---

## 1. Feature の定義

### 1.1 Feature とは

> **Feature** = 独立して価値を提供できる機能の単位

**特徴:**
- 1つ以上のユースケース (UC) を含む
- 独立してデプロイ可能（理想的には）
- テストが概ね自己完結

### 1.2 Feature と他の概念の関係

```
Vision Spec
    └── Domain Spec (M-*, API-*, BR-*)
            └── Feature Spec (UC, FR)
                    └── Tasks
                            └── Implementation
```

---

## 2. Feature サイズの判断基準

### 2.1 適切な Feature のサイズ

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Ideal Feature Size                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  Metric                │ Target Range                                │
│  ──────────────────────┼─────────────────────────────────────────────│
│  実装期間               │ 1-3 週間                                    │
│  ユースケース数         │ 2-5 個                                      │
│  画面数                 │ 1-3 画面                                    │
│  API エンドポイント     │ 2-7 個                                      │
│  Tasks 数               │ 5-15 個                                     │
│                                                                      │
│  テストケース目安:                                                   │
│    Unit                │ 10-30 件                                    │
│    Integration         │ 3-10 件                                     │
│    E2E                 │ 1-5 件                                      │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 Feature サイズ分類

| サイズ | 実装期間 | UC 数 | テスト合計 | 判断 |
|--------|---------|-------|-----------|------|
| **Micro** | < 1 週間 | 1 | < 15 件 | 統合を検討 |
| **Small** | 1-2 週間 | 2-3 | 15-30 件 | 理想的 |
| **Medium** | 2-3 週間 | 3-5 | 30-45 件 | 理想的 |
| **Large** | > 3 週間 | > 5 | > 45 件 | 分割を検討 |

---

## 3. Feature を分割すべきサイン

以下のいずれかに該当する場合、Feature の分割を検討する。

### 3.1 チェックリスト

- [ ] **UC が 7 個以上ある**
  - 多すぎるユースケースは複数の価値を含んでいる可能性

- [ ] **実装見積もりが 1 ヶ月以上**
  - 長期化するとリスクが増大

- [ ] **複数の独立したユーザー価値がある**
  - 例: 「検索」と「お気に入り」は別の価値

- [ ] **異なるアクターが主体の UC が混在**
  - 例: 「管理者の UC」と「一般ユーザーの UC」

- [ ] **テストケースが 50 個以上になりそう**
  - テスト管理が困難になる

- [ ] **一部だけ先にリリースしたい**
  - ビジネス要件で段階リリースが必要

- [ ] **複数チームが関与する**
  - 所有権が分散すると調整コストが増加

### 3.2 分割の方法

```
大きな Feature
    │
    ├── 分割パターン 1: Actor 別
    │   ├── Feature A: 管理者向け機能
    │   └── Feature B: 一般ユーザー向け機能
    │
    ├── 分割パターン 2: フロー別
    │   ├── Feature A: 登録フロー
    │   ├── Feature B: 編集フロー
    │   └── Feature C: 削除フロー
    │
    ├── 分割パターン 3: 段階別
    │   ├── Feature A: MVP (必須機能)
    │   └── Feature B: 拡張機能
    │
    └── 分割パターン 4: 画面別
        ├── Feature A: 一覧画面
        └── Feature B: 詳細画面
```

### 3.3 分割時の注意点

- **依存関係を明確に**: Feature 間の Hard/Soft dependency を定義
- **共通部分は Domain へ**: M-*/API-* は Domain Spec で管理
- **テストの重複を最小化**: 共通テストは Foundation/Domain レベルへ

---

## 4. Feature を統合すべきサイン

以下のいずれかに該当する場合、Feature の統合を検討する。

### 4.1 チェックリスト

- [ ] **他の Feature なしでは意味をなさない**
  - 例: 「カート追加」だけでは価値がない

- [ ] **常にセットで変更される**
  - 片方を変更すると必ず他方も変更

- [ ] **テストが高度に重複する**
  - 同じシナリオを複数 Feature でテスト

- [ ] **同じ画面内の密結合した機能**
  - 例: 同じフォーム内の関連フィールド

- [ ] **単独では 3 日以内で終わる小さな変更**
  - オーバーヘッドが価値を上回る

### 4.2 統合の方法

```
小さな Feature A + 小さな Feature B
    │
    └── 統合後: Feature AB
        ├── UC-001 (元 Feature A)
        ├── UC-002 (元 Feature A)
        ├── UC-003 (元 Feature B)
        └── UC-004 (元 Feature B)
```

---

## 5. Feature 粒度とテストの関係

### 5.1 Feature サイズとテスト配分

| サイズ | Unit | Integration | E2E | 合計 |
|--------|------|-------------|-----|------|
| Micro | 5-10 | 1-3 | 0-1 | ~15 |
| Small | 10-20 | 3-5 | 1-3 | ~25 |
| Medium | 20-30 | 5-10 | 3-5 | ~40 |
| Large | 30+ | 10+ | 5+ | 50+ |

### 5.2 テストスコープの階層

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Test Scope by Feature Size                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  L0: Foundation                                                      │
│  │   - 全 Feature 共通のテスト                                       │
│  │   - Feature サイズに依存しない                                    │
│  │                                                                   │
│  L1: Domain                                                          │
│  │   - M-*/API-* のテスト                                            │
│  │   - 複数 Feature で共有                                           │
│  │                                                                   │
│  L2: Feature                                                         │
│  │   - Feature 固有のテスト                                          │
│  │   - サイズに応じてテスト量が変動                                  │
│  │                                                                   │
│  L3: Cross-Feature                                                   │
│      - 複数 Feature を横断するテスト                                 │
│      - Feature 間の依存が増えると増加                                │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.3 Feature 分割とテスト影響

**分割前:**
```
Feature X (Large)
├── Unit: 50 件
├── Integration: 15 件
└── E2E: 8 件
合計: 73 件（管理困難）
```

**分割後:**
```
Feature X-A (Medium)
├── Unit: 25 件
├── Integration: 7 件
└── E2E: 4 件
合計: 36 件

Feature X-B (Medium)
├── Unit: 25 件
├── Integration: 8 件
└── E2E: 4 件
合計: 37 件

Cross-Feature (X-A + X-B)
└── Journey: 2 件

全体: 75 件（分類されて管理容易）
```

---

## 6. 実践的な判断フロー

```
新しい Feature を定義
    │
    ▼
┌─────────────────────────────────────┐
│ Step 1: UC 数を数える               │
├─────────────────────────────────────┤
│ UC 数は何個か？                     │
│   │                                 │
│   ├── 1 個 → Micro（統合検討）       │
│   ├── 2-5 個 → 適切                 │
│   └── 6+ 個 → 分割検討              │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│ Step 2: 実装期間を見積もる          │
├─────────────────────────────────────┤
│ 何週間かかるか？                    │
│   │                                 │
│   ├── < 1 週間 → Micro（統合検討）   │
│   ├── 1-3 週間 → 適切               │
│   └── > 3 週間 → 分割検討           │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│ Step 3: 独立性を確認                │
├─────────────────────────────────────┤
│ 独立してリリース可能か？            │
│   │                                 │
│   ├── Yes → OK                      │
│   └── No → 依存先を確認             │
│           ├── Hard → 先に完了必要    │
│           └── Soft → 並行開発可能    │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│ Step 4: テスト量を見積もる          │
├─────────────────────────────────────┤
│ テストケースは何件？                │
│   │                                 │
│   ├── < 15 件 → Micro（統合検討）    │
│   ├── 15-45 件 → 適切               │
│   └── > 45 件 → 分割検討            │
└─────────────────────────────────────┘
    │
    ▼
最終判断
```

---

## 7. Examples

### 7.1 分割が適切な例

**Before: E-Commerce Feature (Large)**
- UC-001: 商品検索
- UC-002: 商品詳細表示
- UC-003: カート追加
- UC-004: カート編集
- UC-005: チェックアウト
- UC-006: 決済
- UC-007: 注文確認
- UC-008: 注文履歴

**After: 3 Features に分割**

1. **S-CATALOG-001: 商品カタログ**
   - UC-001: 商品検索
   - UC-002: 商品詳細表示

2. **S-CART-001: ショッピングカート**
   - UC-003: カート追加
   - UC-004: カート編集

3. **S-ORDER-001: 注文処理**
   - UC-005: チェックアウト
   - UC-006: 決済
   - UC-007: 注文確認
   - UC-008: 注文履歴

### 7.2 統合が適切な例

**Before: 2 Micro Features**

1. **S-LOGIN-001: ログイン**
   - UC-001: ログイン

2. **S-LOGOUT-001: ログアウト**
   - UC-001: ログアウト

**After: 1 Small Feature**

**S-AUTH-001: 認証**
- UC-001: ログイン
- UC-002: ログアウト
- UC-003: パスワードリセット（追加）

---

## 8. Related Documents

- [test-strategy-proposal.md](../docs/test-strategy-proposal.md) - テスト戦略提案
- [test-design.md](../templates/test-design.md) - テスト設計テンプレート
- [feature-spec.md](../templates/feature-spec.md) - Feature Spec テンプレート

---

## Changelog

| Date | Version | Change | Author |
|------|---------|--------|--------|
| 2026-01-06 | 1.0.0 | Initial creation | AI Assistant |
