# Revised Test Strategy v2.0

Status: **Proposal**
Created: 2026-01-06
Version: 2.0.0

---

## Executive Summary

v1.x の提案を批判的に再検討し、より現実的で AI エージェント向けに最適化された戦略に改訂。

### 核心的な方針転換

| 観点 | v1.x | v2.0 |
|------|------|------|
| 状態管理 | AI が責任を持つ | **ツールが責任を持つ** |
| 分析レベル | すべて同じ | **リスクに応じて段階的** |
| フェーズ追加 | Requirements Analysis 新設 | **QA を拡張** |
| テンプレート | 網羅的（367行） | **軽量（50-100行）** |
| 目標 | 完璧な分析 | **80/20 の法則** |

---

## 1. 問題の再定義

### 1.1 表面的な問題 vs 根本原因

```
表面的な問題                    根本原因
─────────────────────────      ─────────────────────────────────────
チェック漏れが発生する    →    チェックする責任が AI にある
エッジケースが漏れる      →    パターン分析がない/重すぎて形骸化
テストが後になる          →    テスト設計と実装が分離されていない
ドキュメントが長い        →    すべてに同じレベルを要求している
```

### 1.2 AI エージェント特有の制約

```
┌─────────────────────────────────────────────────────────────────────┐
│ AI エージェントの特性と設計への影響                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 制約1: コンテキスト制限                                              │
│   → 長いドキュメントは処理しきれない                                │
│   → テンプレートは軽量に                                            │
│                                                                      │
│ 制約2: 状態の非永続性                                                │
│   → セッション間で状態を忘れる                                      │
│   → 状態は外部ツールで管理                                          │
│                                                                      │
│ 制約3: 手順の忘却                                                    │
│   → 長いチェックリストは漏れる                                      │
│   → 自動化できるものは自動化                                        │
│                                                                      │
│ 制約4: 判断のばらつき                                                │
│   → 「完了」の判断が一貫しない                                      │
│   → 明確な完了条件 + ツールによる検証                               │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. 改訂版アーキテクチャ

### 2.1 責任の再配置

```
┌─────────────────────────────────────────────────────────────────────┐
│ Before: AI が責任を持つ                                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  AI の責任:                                                          │
│  ├── コードを書く                                                    │
│  ├── テストを書く                                                    │
│  ├── tasks.md にチェックを入れる        ← 忘れる                     │
│  ├── test-scenario.md を更新する        ← 忘れる                     │
│  ├── TodoWrite を更新する               ← 忘れる                     │
│  └── 状態の整合性を維持する             ← 破綻する                   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ After: ツールが責任を持つ                                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  AI の責任（シンプル）:                                              │
│  ├── コードを書く                                                    │
│  ├── テストを書く                                                    │
│  └── コミットする                                                    │
│                                                                      │
│  ツールの責任（自動）:                                               │
│  ├── コミットを検出 → タスク完了をマーク                            │
│  ├── テスト実行 → 結果を自動記録                                    │
│  ├── 状態の整合性を維持                                             │
│  └── 進捗レポートを生成                                             │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 ワークフローの変更

```
【現行】
Input → QA → Spec → Plan → Tasks → Implement → E2E

【v1.x 提案】（却下）
Input → Req.Analysis → QA → Spec → TestDesign → Plan → TDD → Verify
        ^^^^^^^^^^^^^              ^^^^^^^^^^
        新規追加                   新規追加

【v2.0 提案】
Input → QA+ → Spec → Plan+ → Tasks → Implement+ → E2E
        ^^^          ^^^^            ^^^^^^^^^^
        拡張         拡張            自動追跡

変更点:
1. QA+ : パターン分析を統合（必要な場合のみ）
2. Plan+ : テストアプローチを統合
3. Implement+ : hooks による自動状態追跡
```

### 2.3 段階的厳格化モデル

```
┌─────────────────────────────────────────────────────────────────────┐
│ Rigor Level による分析深度の調整                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ Level 1: Minimal（探索的・MVP）                                      │
│ ─────────────────────────────                                        │
│ • QA: 基本確認（5-10 問）                                            │
│ • 分析: なし                                                         │
│ • テスト: ハッピーパス + 主要異常系（5-10 ケース）                   │
│ • 適用: MVP、プロトタイプ、実験的機能                               │
│                                                                      │
│ Level 2: Standard（通常の機能）                                      │
│ ─────────────────────────────                                        │
│ • QA: 詳細確認（10-20 問）                                           │
│ • 分析: 境界値 + 主要パターン                                        │
│ • テスト: Level 1 + エッジケース（15-30 ケース）                     │
│ • 適用: 正式リリース機能                                            │
│                                                                      │
│ Level 3: Rigorous（高リスク機能）                                    │
│ ─────────────────────────────                                        │
│ • QA: 包括的確認                                                     │
│ • 分析: DT + 状態遷移図 + 同値分割                                   │
│ • テスト: Level 2 + 網羅的テスト（30-50+ ケース）                    │
│ • 適用: 決済、認証、コアビジネスロジック                            │
│                                                                      │
│ Level 判定基準:                                                      │
│ ┌──────────────────┬─────────┬──────────┬──────────┐                 │
│ │ 判定項目          │ Level 1 │ Level 2  │ Level 3  │                 │
│ ├──────────────────┼─────────┼──────────┼──────────┤                 │
│ │ ビジネスインパクト │ 低      │ 中       │ 高       │                 │
│ │ 金銭的影響        │ なし    │ 間接的   │ 直接的   │                 │
│ │ セキュリティ      │ 低      │ 中       │ 高       │                 │
│ │ 複雑度            │ 単純    │ 普通     │ 複雑     │                 │
│ │ 条件分岐数        │ 1-3     │ 4-8      │ 9+       │                 │
│ │ 状態数            │ 1-2     │ 3-5      │ 6+       │                 │
│ └──────────────────┴─────────┴──────────┴──────────┘                 │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. 実装計画

### 3.1 Phase 0: Task 追跡の自動化（最優先）

```
目的: チェック漏れ問題の根本解決

実装:
1. Git hooks による自動追跡
   - pre-commit: タスク ID をコミットメッセージから抽出
   - post-commit: state.json を自動更新

2. テスト結果の自動記録
   - npm test 実行後に結果を parse
   - state.json に自動反映

3. 進捗レポート生成
   - state query --progress で現在状態を確認
   - AI は状態を「管理」せず「参照」するだけ

詳細: → task-tracking-automation.md
```

### 3.2 Phase 1: QA の拡張

```
目的: パターン分析を QA に統合

変更:
1. QA テンプレートに「パターン分析」セクション追加
   - Level 1: 省略可
   - Level 2: 境界値リスト
   - Level 3: DT / 状態遷移図

2. QA ワークフローに分析ステップ追加
   - Rigor Level の判定
   - Level に応じた分析実施

3. 既存の requirements-analysis.md は Level 3 専用に

詳細: → qa-enhancement.md
```

### 3.3 Phase 2: Plan の拡張

```
目的: テスト設計を Plan に統合

変更:
1. Plan テンプレートに「テストアプローチ」セクション追加
   - テスト種類と範囲
   - 重点テスト領域
   - テストデータ要件

2. Test Design を独立フェーズではなく Plan の一部に

詳細: → plan-enhancement.md（必要に応じて作成）
```

### 3.4 Phase 3: テンプレート軽量化

```
目的: 80/20 の法則に基づく軽量化

変更:
1. requirements-analysis.md
   - 367行 → 80行程度
   - Level 3 専用
   - 必須セクションのみ残す

2. test-design.md
   - 独立テンプレートではなく Plan 内のセクションに

3. 新規: lightweight-templates/
   - qa-level1.md（最小限）
   - qa-level2.md（標準）
   - qa-level3.md（厳格）

詳細: → lightweight-templates.md
```

### 3.5 Phase 4: 補完要素の追加

```
目的: 見落とし要素のカバー

追加:
1. テストデータ戦略（シンプル版）
   - フィクスチャ管理
   - シードデータ
   - クリーンアップ

2. 非機能要件テスト（最小限）
   - パフォーマンス基準
   - セキュリティチェックリスト
   - アクセシビリティ基本

詳細: → supplementary-testing.md
```

---

## 4. 成功基準

### 4.1 定量的指標

| 指標 | 現状 | 目標 |
|------|------|------|
| チェック漏れ率 | 高 | < 5% |
| エッジケース漏れ | 頻発 | 重大なもの 0 |
| テンプレート行数 | 367行 | < 100行 |
| ワークフローステップ数 | 7 | 7（維持） |

### 4.2 定性的指標

- [ ] AI がチェック操作を意識しなくて良い
- [ ] Rigor Level に応じた適切な分析深度
- [ ] ドキュメントが形骸化しない
- [ ] 人間のレビュー負荷が適切

---

## 5. リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| hooks 実装の複雑さ | 開発遅延 | MVP から始める |
| Level 判定の曖昧さ | 一貫性欠如 | 明確な判定基準表 |
| 軽量化しすぎ | 品質低下 | Level 3 は厳格に維持 |
| 既存ワークフローへの影響 | 混乱 | proposals/ で検証後に適用 |

---

## 6. ドキュメント構成

```
proposals/test-strategy-2026-01/
├── README.md                      # 概要（更新）
├── revised-strategy.md            # ★ このファイル（メイン）
├── task-tracking-automation.md    # Phase 0 詳細
├── qa-enhancement.md              # Phase 1 詳細
├── graduated-rigor.md             # 段階的厳格化モデル詳細
├── supplementary-testing.md       # テストデータ・非機能要件
├── lightweight-templates/         # 軽量化テンプレート
│   ├── qa-level1.md
│   ├── qa-level2.md
│   └── qa-level3.md
└── archive/                       # v1.x のドキュメント（参考用）
    ├── test-strategy-proposal.md
    ├── requirements-analysis.md
    ├── test-design.md
    └── ...
```

---

## 7. Next Actions

1. **即座に着手**: task-tracking-automation.md の詳細設計
2. **並行**: qa-enhancement.md の作成
3. **その後**: graduated-rigor.md の詳細化
4. **最後**: 軽量化テンプレートの作成

---

## Changelog

| Date | Version | Change | Author |
|------|---------|--------|--------|
| 2026-01-06 | 2.0.0 | v1.x を批判的に再検討し、全面改訂 | AI Assistant |
