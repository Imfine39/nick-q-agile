# Supplementary Testing Guide

Status: **Proposal**
Created: 2026-01-06

---

## 1. 概要

v1.x で見落としていた以下の要素をカバー:

1. テストデータ戦略
2. 非機能要件テスト
3. テスト環境戦略
4. テスト保守性

---

## 2. テストデータ戦略

### 2.1 テストデータの分類

```
┌─────────────────────────────────────────────────────────────────────┐
│ テストデータの種類                                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 1. シードデータ（Seed Data）                                         │
│    • 初期状態として必要なデータ                                     │
│    • マスタデータ、設定データ                                       │
│    • 例: ユーザーロール、カテゴリ、都道府県                         │
│                                                                      │
│ 2. フィクスチャ（Fixture）                                           │
│    • テスト用の固定データセット                                     │
│    • 再現性のあるテストに必要                                       │
│    • 例: テストユーザー、テスト商品                                 │
│                                                                      │
│ 3. ファクトリ（Factory）                                             │
│    • テストデータを動的に生成                                       │
│    • バリエーションが必要な場合                                     │
│    • 例: ランダムなユーザー名、日付                                 │
│                                                                      │
│ 4. モック/スタブ                                                     │
│    • 外部サービスの代替                                             │
│    • 制御された応答を返す                                           │
│    • 例: 決済API、メール送信                                        │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 テストデータ管理の原則

```
┌─────────────────────────────────────────────────────────────────────┐
│ 原則                                                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 1. 独立性                                                            │
│    • 各テストは他のテストに依存しない                               │
│    • テスト順序を変えても結果は同じ                                 │
│                                                                      │
│ 2. 再現性                                                            │
│    • 同じテストは常に同じ結果                                       │
│    • 日時やランダム値は固定可能に                                   │
│                                                                      │
│ 3. 最小限                                                            │
│    • テストに必要な最小限のデータのみ                               │
│    • 過剰なデータはテストを遅くする                                 │
│                                                                      │
│ 4. クリーンアップ                                                    │
│    • テスト後は元の状態に戻す                                       │
│    • トランザクションロールバック or 明示的削除                     │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.3 テストデータパターン

```
┌─────────────────────────────────────────────────────────────────────┐
│ Level 別のテストデータ要件                                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ Level 1 (Minimal):                                                   │
│ • インラインデータで十分                                            │
│ • フィクスチャ不要                                                  │
│ • 例:                                                                │
│   test('should create user', () => {                                │
│     const user = { name: 'Test', email: 'test@example.com' };       │
│   });                                                                │
│                                                                      │
│ Level 2 (Standard):                                                  │
│ • 共通フィクスチャを使用                                            │
│ • ファクトリを必要に応じて使用                                      │
│ • 例:                                                                │
│   import { fixtures } from '@test/fixtures';                        │
│   const user = fixtures.validUser();                                │
│                                                                      │
│ Level 3 (Rigorous):                                                  │
│ • 包括的なフィクスチャセット                                        │
│ • エッジケース用のファクトリ                                        │
│ • データベースシーディング                                          │
│ • 例:                                                                │
│   import { factory } from '@test/factory';                          │
│   import { seedDatabase } from '@test/seed';                        │
│   beforeAll(() => seedDatabase('auth-scenarios'));                  │
│   const user = factory.user({ role: 'admin', verified: false });    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.4 テストデータディレクトリ構造

```
tests/
├── fixtures/
│   ├── users.json           # ユーザーフィクスチャ
│   ├── products.json        # 商品フィクスチャ
│   └── index.ts             # エクスポート
│
├── factories/
│   ├── userFactory.ts       # ユーザーファクトリ
│   ├── productFactory.ts    # 商品ファクトリ
│   └── index.ts             # エクスポート
│
├── seeds/
│   ├── base.sql             # 基本シードデータ
│   ├── auth-scenarios.sql   # 認証テスト用
│   └── payment-scenarios.sql# 決済テスト用
│
└── mocks/
    ├── paymentApi.ts        # 決済APIモック
    ├── emailService.ts      # メールサービスモック
    └── index.ts             # エクスポート
```

---

## 3. 非機能要件テスト

### 3.1 非機能要件の種類と適用レベル

```
┌─────────────────────────────┬─────────┬─────────┬─────────┐
│ 非機能要件                   │ Level 1 │ Level 2 │ Level 3 │
├─────────────────────────────┼─────────┼─────────┼─────────┤
│ パフォーマンス              │ -       │ 基本    │ 詳細    │
│ セキュリティ                │ -       │ 基本    │ 詳細    │
│ アクセシビリティ            │ -       │ 基本    │ 詳細    │
│ 負荷テスト                  │ -       │ -       │ 基本    │
│ 可用性                      │ -       │ -       │ 基本    │
└─────────────────────────────┴─────────┴─────────┴─────────┘
```

### 3.2 パフォーマンステスト

```
┌─────────────────────────────────────────────────────────────────────┐
│ パフォーマンス基準                                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ Level 2 (基本):                                                      │
│ • API レスポンス: < 500ms (95パーセンタイル)                        │
│ • ページロード: < 3s (初回)                                         │
│ • データベースクエリ: < 100ms                                       │
│                                                                      │
│ Level 3 (詳細):                                                      │
│ • API レスポンス: < 200ms (99パーセンタイル)                        │
│ • ページロード: < 1.5s (初回), < 500ms (キャッシュ後)               │
│ • データベースクエリ: < 50ms                                        │
│ • メモリ使用量: < 100MB (ピーク時)                                  │
│ • 同時接続: 100+ ユーザー                                           │
│                                                                      │
│ テスト方法:                                                          │
│ • Jest の --detectOpenHandles でリーク検出                          │
│ • Lighthouse CI でフロントエンド計測                                │
│ • k6 / Artillery で負荷テスト                                       │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3 セキュリティテスト

```
┌─────────────────────────────────────────────────────────────────────┐
│ セキュリティチェックリスト                                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ Level 2 (基本):                                                      │
│ □ 入力バリデーション                                                │
│   - XSS 対策（HTMLエスケープ）                                      │
│   - SQL インジェクション対策（パラメータ化クエリ）                  │
│   - パストラバーサル対策                                            │
│ □ 認証                                                               │
│   - パスワードハッシュ化（bcrypt）                                  │
│   - セッション管理                                                   │
│ □ HTTPS 強制                                                         │
│                                                                      │
│ Level 3 (詳細):                                                      │
│ □ Level 2 のすべて                                                   │
│ □ CSRF 対策                                                          │
│ □ レート制限                                                         │
│ □ 機密データの暗号化（at rest / in transit）                        │
│ □ 監査ログ                                                           │
│ □ 権限昇格の防止                                                     │
│ □ セキュリティヘッダー                                              │
│   - Content-Security-Policy                                         │
│   - X-Frame-Options                                                  │
│   - X-Content-Type-Options                                          │
│ □ 依存関係の脆弱性スキャン（npm audit）                             │
│                                                                      │
│ テストツール:                                                        │
│ • OWASP ZAP（自動スキャン）                                         │
│ • npm audit / Snyk（依存関係）                                      │
│ • ESLint security plugin（静的解析）                                │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.4 アクセシビリティテスト

```
┌─────────────────────────────────────────────────────────────────────┐
│ アクセシビリティ基準                                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ Level 2 (基本):                                                      │
│ □ 画像に alt テキスト                                               │
│ □ フォームラベルの関連付け                                          │
│ □ 十分なコントラスト比                                              │
│ □ キーボードナビゲーション可能                                      │
│                                                                      │
│ Level 3 (詳細):                                                      │
│ □ WCAG 2.1 AA 準拠                                                  │
│ □ スクリーンリーダー対応                                            │
│ □ フォーカス管理                                                     │
│ □ 動的コンテンツのアナウンス                                        │
│ □ 十分なターゲットサイズ                                            │
│                                                                      │
│ テストツール:                                                        │
│ • axe-core / jest-axe（自動テスト）                                 │
│ • Lighthouse（監査）                                                │
│ • 手動テスト（スクリーンリーダー）                                  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. テスト環境戦略

### 4.1 環境の種類

```
┌─────────────────────────────────────────────────────────────────────┐
│ テスト環境                                                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ Local (開発者マシン):                                                │
│ • ユニットテスト                                                     │
│ • 統合テスト（モック使用）                                          │
│ • 高速フィードバック優先                                            │
│                                                                      │
│ CI (GitHub Actions等):                                               │
│ • 全テストスイート                                                   │
│ • Docker で依存関係を管理                                           │
│ • PR ごとに実行                                                      │
│                                                                      │
│ Staging (本番相当):                                                  │
│ • E2E テスト                                                         │
│ • パフォーマンステスト                                              │
│ • 本番データの匿名化コピー                                          │
│                                                                      │
│ Production:                                                          │
│ • スモークテストのみ                                                │
│ • 監視/アラート                                                      │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 環境依存の扱い

```
┌─────────────────────────────────────────────────────────────────────┐
│ 環境変数と設定                                                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 方針:                                                                │
│ • テスト用の環境変数は .env.test で管理                             │
│ • シークレットは CI の Secrets で管理                               │
│ • 本番の設定値をテストに使わない                                    │
│                                                                      │
│ 例:                                                                  │
│ # .env.test                                                          │
│ DATABASE_URL=postgres://localhost:5432/test_db                      │
│ REDIS_URL=redis://localhost:6379/1                                  │
│ API_KEY=test_api_key_xxx                                            │
│ EXTERNAL_SERVICE_URL=http://localhost:9999  # モックサーバー        │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.3 外部サービスの扱い

```
┌─────────────────────────────────────────────────────────────────────┐
│ 外部サービスのテスト戦略                                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 方針: 可能な限りモック、本番相当環境でのみ実サービス                │
│                                                                      │
│ モック使用（Local/CI）:                                              │
│ • 決済API → stripe-mock / 自作モック                                │
│ • メール → ethereal.email / モック                                  │
│ • 外部API → msw (Mock Service Worker)                               │
│                                                                      │
│ 実サービス使用（Staging）:                                          │
│ • 決済API → Stripe Test Mode                                        │
│ • メール → MailHog / Mailpit（ローカルSMTP）                       │
│ • 外部API → Sandbox 環境                                            │
│                                                                      │
│ 注意:                                                                │
│ • 本番の認証情報をテストに使わない                                  │
│ • テスト用アカウントを明確に分離                                    │
│ • コストが発生するサービスは特に注意                                │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 5. テスト保守性

### 5.1 テストコードの品質

```
┌─────────────────────────────────────────────────────────────────────┐
│ テストコードの原則                                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 1. Arrange-Act-Assert (AAA)                                         │
│    • テストを 3 部構成に                                            │
│    • 読みやすさ向上                                                  │
│                                                                      │
│ 2. 1 テスト 1 アサーション（目安）                                  │
│    • 失敗原因を特定しやすく                                         │
│    • 関連するアサーションはまとめてOK                               │
│                                                                      │
│ 3. テスト名は仕様を表す                                             │
│    • should_returnError_when_emailIsInvalid                         │
│    • 「何を」「どんな条件で」「どうなる」                           │
│                                                                      │
│ 4. マジックナンバーを避ける                                         │
│    • 定数や fixtures を使用                                         │
│    • 意図を明確に                                                    │
│                                                                      │
│ 5. テストの重複を避ける                                             │
│    • ヘルパー関数を活用                                             │
│    • ただし可読性とのバランス                                       │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.2 フレーキーテスト対策

```
┌─────────────────────────────────────────────────────────────────────┐
│ フレーキーテスト（不安定なテスト）の原因と対策                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 原因1: タイミング依存                                                │
│ 対策: 明示的な待機、retry ロジック                                  │
│                                                                      │
│ 原因2: 順序依存                                                      │
│ 対策: テストの独立性確保、beforeEach でリセット                     │
│                                                                      │
│ 原因3: 環境依存                                                      │
│ 対策: 環境変数の固定、Docker 使用                                   │
│                                                                      │
│ 原因4: 外部サービス依存                                              │
│ 対策: モック使用、タイムアウト設定                                  │
│                                                                      │
│ 原因5: 日時依存                                                      │
│ 対策: タイムトラベル（jest.useFakeTimers）                          │
│                                                                      │
│ 対応フロー:                                                          │
│ 1. フレーキーテストを検出（CI で追跡）                              │
│ 2. 原因を特定                                                        │
│ 3. 修正 or 一時的に skip（@flaky タグ）                             │
│ 4. 放置しない（技術的負債）                                         │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.3 テストの削除基準

```
┌─────────────────────────────────────────────────────────────────────┐
│ テストを削除してよいケース                                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ ✓ 削除対象:                                                         │
│ • 対象コードが削除された                                            │
│ • 別のテストで完全にカバーされている                                │
│ • 常にパスする無意味なテスト                                        │
│ • ビジネス価値がなくなった機能のテスト                              │
│                                                                      │
│ ✗ 削除してはいけない:                                               │
│ • 「遅いから」という理由だけ                                        │
│ • 「失敗するから」という理由だけ（修正すべき）                      │
│ • リグレッション防止に必要なテスト                                  │
│                                                                      │
│ 削除時の手順:                                                        │
│ 1. 削除理由をコミットメッセージに記録                               │
│ 2. カバレッジが下がる場合は代替を用意                               │
│ 3. チームでレビュー                                                  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 6. Plan への統合

### 6.1 テストアプローチセクション（Plan テンプレート追加案）

```markdown
## Test Approach

### テストデータ

| 種類 | 方法 | 説明 |
|------|------|------|
| シード | {seed/fixture/inline} | {説明} |
| ファクトリ | {使用する/しない} | {説明} |
| モック | {対象サービス} | {説明} |

### 非機能要件（Level 2/3）

| 項目 | 基準 | テスト方法 |
|------|------|-----------|
| パフォーマンス | {基準} | {方法} |
| セキュリティ | {チェック項目} | {方法} |

### 環境

| 環境 | 実行するテスト |
|------|----------------|
| Local | ユニット, 統合（モック） |
| CI | 全テスト |
| Staging | E2E |
```

---

## Changelog

| Date | Version | Change |
|------|---------|--------|
| 2026-01-06 | 1.0.0 | Initial proposal |
