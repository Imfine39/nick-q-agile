# Test Strategy Proposal

Version: 1.1.0 | Created: 2026-01-06 | Updated: 2026-01-06 | Status: Proposal

---

## 1. Executive Summary

現在のワークフローにおけるテスト戦略の課題を分析し、改善案を提案する。

### 1.1 主要な課題

| 課題 | 現状 | 影響 |
|------|------|------|
| **要件分析フェーズの欠如** | QA は質問ベース | パターン漏れ、エッジケース未発見 |
| Test Scenario が実装後 | implement → test-scenario | TDD の思想に反する |
| テスト種類が限定的 | Unit/Integration/E2E のみ | 網羅性不足 |
| テスト設計技法の欠如 | 明示されていない | エッジケース漏れ |
| カバレッジ基準なし | 「Critical paths」のみ | 品質基準が曖昧 |
| Feature とテストの関係が不明確 | Feature 毎の定義のみ | 横断テスト考慮不足 |

### 1.2 根本原因の特定

```
問題の連鎖:
パターン出しが甘い → QA が穴埋めになる → Spec にパターン漏れ → テストでカバー不能 → エラー残存
```

**核心的な課題:**
- 現在の QA は「ユーザーの知識ギャップを埋める質問」
- 本来必要なのは「パターンを網羅的に分析する要件分析」
- ディシジョンテーブル、状態遷移図、CRUD マトリックスがない

### 1.3 提案の骨子

1. **★ 要件分析フェーズの追加**: Input → Requirements Analysis → QA → Spec
2. **テスト設計フェーズの追加**: Spec → Test Design → Plan
3. **テストスコープの階層化**: Foundation / Domain / Feature / Cross-Feature
4. **TDD サイクルの徹底**: Red → Green → Refactor
5. **Feature 粒度ガイドラインの策定**

---

## 2. Current State Analysis

### 2.1 現在のテストの位置づけ

```
現行フロー:
Spec → Plan → Tasks → Implement → [test-scenario] → [e2e] → PR
                              ↑
                        テスト設計は後
```

**現状のテスト関連要素:**

| 場所 | 内容 |
|------|------|
| `feature-spec.md` Section 10 | Test Coverage マトリックス（UC/FR → Test Type） |
| `plan.md` Section 5 | Testing Strategy（Unit/Integration/E2E の責任分担） |
| `tasks.md` | Task Type ごとの Required Tests 定義 |
| `implement.md` Step 3.3 | Fail-first（テスト先行）の記載 |
| `test-scenario.md` | Positive/Negative/Journey テスト定義 |
| `e2e.md` | Chrome 拡張によるブラウザテスト |

### 2.2 問題点の詳細

#### 2.2.1 Test Scenario が実装後

```
問題:
  implement.md で "Write tests first" と記載
  しかし test-scenario.md は implement 後に実行

矛盾:
  テストを先に書く（TDD）vs テスト設計が後（現状）
```

#### 2.2.2 テストの種類が不十分

| SIer 標準 | 現ワークフロー | Gap |
|-----------|---------------|-----|
| 単体テスト (UT) | Unit tests | △ 詳細定義が薄い |
| 結合テスト (IT) | Integration tests | △ 範囲が曖昧 |
| 総合テスト (ST) | E2E tests | △ システムテストとの区別なし |
| 受入テスト (UAT) | なし | 欠如 |
| 回帰テスト | なし | 体系化されていない |
| 性能テスト | なし | 欠如 |
| セキュリティテスト | なし | 欠如 |

#### 2.2.3 テスト設計技法の欠如

以下の標準的技法が言及されていない:

- **同値分割 (Equivalence Partitioning)**: 入力を同等クラスに分割
- **境界値分析 (BVA)**: 境界値周辺のテスト
- **決定表テスト**: 条件の組み合わせ
- **状態遷移テスト**: 状態変化のテスト
- **ペアワイズテスト**: 組み合わせ爆発の対策

#### 2.2.4 ホワイトボックス/ブラックボックスの概念がない

| テスト観点 | 説明 | 現状 |
|-----------|------|------|
| ブラックボックス | 入出力のみ確認 | △ AC ベースだが明示なし |
| ホワイトボックス | 内部構造を確認 | 欠如（カバレッジの概念なし） |
| グレーボックス | 両方の組み合わせ | なし |

#### 2.2.5 ★ 要件分析フェーズの欠如（根本原因）

**現状の QA の問題:**

```
現在の QA:
  目的: ユーザーの知識ギャップを埋める
  形式: 質問 → 回答
  例:
    Q: 「パスワードの最小文字数は？」
    A: 「8文字」

  問題: これは「パラメータ確認」であり「パターン分析」ではない
```

**本来必要なこと:**

```
要件分析:
  目的: すべてのパターンを事前に洗い出す
  形式: 分析 → 確認
  例:
    業務フロー図で全状態・全遷移を可視化
    ディシジョンテーブルで全条件組み合わせを網羅
    入力パターン分析で全入力クラスを特定

  効果: パターン漏れがなくなる
```

**これが欠如することで生じる問題:**

```
┌─────────────────────────────────────────────────────────────────────┐
│ 問題の連鎖                                                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  1. パターン出しが甘い                                               │
│     └── ディシジョンテーブルがない                                   │
│     └── 業務フロー図がない                                           │
│     └── 状態遷移が整理されていない                                   │
│                                                                      │
│  2. QA が「穴埋め質問」になっている                                  │
│     └── 「何がわからないか」を聞いている                             │
│     └── 「どんなパターンがあるか」を分析していない                   │
│                                                                      │
│  3. Spec 作成時にパターンが漏れる                                    │
│     └── 後から「このケースは？」が発生                               │
│     └── 実装中に「エッジケース」が発見される                         │
│                                                                      │
│  4. テストでカバーしきれない                                         │
│     └── そもそも Spec に書かれていない                               │
│     └── テスト設計以前の問題                                         │
│                                                                      │
│  5. エラーが残る                                                     │
│     └── 本番で「想定外のパターン」が発生                             │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2.5 ★ Requirements Analysis の提案

### 2.5.1 提案: 要件分析フェーズの追加

```
┌─────────────────────────────────────────────────────────────────────┐
│ Before                                                               │
├─────────────────────────────────────────────────────────────────────┤
│ Input → QA → Spec → Review → Plan → Implement → Test                │
│          ↑                                                           │
│     質問ベース                                                       │
│     パターン分析なし                                                 │
└─────────────────────────────────────────────────────────────────────┘

                              ↓

┌─────────────────────────────────────────────────────────────────────┐
│ After                                                                │
├─────────────────────────────────────────────────────────────────────┤
│ Input                                                                │
│   ↓                                                                  │
│ ★ Requirements Analysis ★ ← 新規追加                                │
│   │                                                                  │
│   ├── 業務フロー図（状態遷移）                                       │
│   ├── ディシジョンテーブル（条件組み合わせ）                         │
│   ├── CRUD マトリックス                                              │
│   └── 入力パターン分析（同値分割・境界値）                           │
│   ↓                                                                  │
│ QA (分析結果の確認) ← 質問ではなく「分析結果の確認」に変化           │
│   ↓                                                                  │
│ Spec (パターンを反映)                                                │
│   ↓                                                                  │
│ Test Design (パターンからテストケース導出)                           │
│   ↓                                                                  │
│ Plan → Implement → Verify                                            │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.5.2 Requirements Analysis の構成要素

#### (1) 業務フロー図（状態遷移図）

```
目的: 業務の流れと状態変化を可視化

例: 注文処理フロー
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ 未注文  │ → │ カート  │ → │ 決済中  │ → │ 確定    │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
                   │              │
                   ↓              ↓
              ┌─────────┐    ┌─────────┐
              │ 破棄    │    │ 失敗    │
              └─────────┘    └─────────┘

チェックポイント:
- [ ] すべての状態を網羅したか
- [ ] すべての遷移を定義したか
- [ ] 各遷移のトリガーは明確か
- [ ] 異常系の遷移を考慮したか
```

#### (2) ディシジョンテーブル

```
目的: 条件の組み合わせを網羅

例: ログイン処理
| 条件                    | R1 | R2 | R3 | R4 | R5 | R6 | R7 | R8 |
|------------------------|----|----|----|----|----|----|----|----|
| メールアドレス形式正しい | T  | T  | T  | T  | F  | F  | F  | F  |
| ユーザー存在            | T  | T  | F  | F  | -  | -  | -  | -  |
| パスワード一致          | T  | F  | -  | -  | -  | -  | -  | -  |
|------------------------|----|----|----|----|----|----|----|----|
| アクション              |    |    |    |    |    |    |    |    |
| ログイン成功            | X  |    |    |    |    |    |    |    |
| パスワードエラー        |    | X  |    |    |    |    |    |    |
| ユーザー不明エラー      |    |    | X  | X  |    |    |    |    |
| 形式エラー              |    |    |    |    | X  | X  | X  | X  |

効果:
- 全8パターンを事前に特定
- 各パターンの期待動作を明確化
- テストケースを漏れなく導出
```

#### (3) CRUD マトリックス

```
目的: データ操作の網羅性確認

| 機能/エンティティ | User | Order | Product | Cart |
|------------------|------|-------|---------|------|
| ユーザー登録      | C    |       |         |      |
| ログイン          | R    |       |         |      |
| プロフィール編集  | U    |       |         |      |
| 退会              | D    | D     |         | D    |
| 商品検索          |      |       | R       |      |
| カート追加        |      |       | R       | C    |
| 注文確定          |      | C     | R       | D    |

チェック:
- [ ] 各エンティティに CRUD すべてあるか
- [ ] 削除時の関連データ処理は定義されているか
```

#### (4) 入力パターン分析

```
目的: 入力値のパターンを網羅

例: メールアドレス入力
┌─────────────────────────────────────────────────────────────────────┐
│ 同値クラス分割                                                       │
├─────────────────────────────────────────────────────────────────────┤
│ 有効クラス:                                                          │
│   E1: 標準形式 (user@example.com)                                    │
│   E2: サブドメインあり (user@mail.example.com)                       │
│   E3: プラス記号あり (user+tag@example.com)                          │
│                                                                      │
│ 無効クラス:                                                          │
│   I1: @なし (userexample.com)                                        │
│   I2: ドメインなし (user@)                                           │
│   I3: ローカル部なし (@example.com)                                  │
│   I4: 空文字 ("")                                                    │
│   I5: スペース含む ("user @example.com")                             │
│   I6: 特殊文字 ("user<script>@example.com")                          │
├─────────────────────────────────────────────────────────────────────┤
│ 境界値:                                                              │
│   B1: ローカル部最大長 (64文字)                                      │
│   B2: ドメイン部最大長 (255文字)                                     │
│   B3: 全体最大長 (254文字)                                           │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.5.3 QA の役割変化

```
┌─────────────────────────────────────────────────────────────────────┐
│ Before: QA = 質問                                                    │
├─────────────────────────────────────────────────────────────────────┤
│ 「パスワードの最小文字数は？」                                       │
│ 「エラーメッセージは何を表示？」                                     │
│ 「ログイン試行回数の上限は？」                                       │
│                                                                      │
│ 問題: 質問者の想像力に依存、パターン漏れ                             │
└─────────────────────────────────────────────────────────────────────┘

                              ↓

┌─────────────────────────────────────────────────────────────────────┐
│ After: QA = 分析結果の確認                                           │
├─────────────────────────────────────────────────────────────────────┤
│ 「ディシジョンテーブルの8パターンで正しいですか？」                  │
│ 「状態遷移図に漏れはありませんか？」                                 │
│ 「入力の同値クラス分割は妥当ですか？」                               │
│                                                                      │
│ 効果: 分析結果を確認するので、パターン漏れが防げる                   │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.5.4 Template

Requirements Analysis テンプレートを作成: `templates/requirements-analysis.md`

---

## 3. TDD との比較

### 3.1 TDD の基本サイクル

```
┌─────────────────────────────────────────────┐
│                  TDD Cycle                  │
│                                             │
│    ┌─────┐      ┌─────┐      ┌──────────┐   │
│    │ Red │ ───→ │Green│ ───→ │ Refactor │   │
│    └─────┘      └─────┘      └──────────┘   │
│        ↑                          │         │
│        └──────────────────────────┘         │
│                                             │
│  Red: テストを書く（失敗確認）               │
│  Green: テストを通す最小限の実装             │
│  Refactor: 品質向上（テストは通ったまま）    │
└─────────────────────────────────────────────┘
```

### 3.2 現ワークフローとの Gap

| TDD の原則 | 現ワークフロー | 状態 |
|-----------|---------------|------|
| テスト先行 | implement.md に "Write tests first" | OK |
| テスト設計を先に | Test Scenario は implement 後 | NG |
| 失敗を確認 | "fail-first" の記載あり | OK |
| 最小実装 | 明示なし | 改善要 |
| リファクタ | 明示なし | NG |

---

## 4. Proposed Solution

### 4.1 テストピラミッドの明確化

```
                      ▲
                     /E2E\           10% - 遅い・高コスト・壊れやすい
                    /─────\
                   /System \         15% - 複数サービス統合
                  /─────────\
                 /Integration\       25% - モジュール間
                /─────────────\
               /   Component   \     20% - コンポーネント単位
              /─────────────────\
             /       Unit        \   30% - 関数・メソッド単位
            /─────────────────────\
```

### 4.2 提案するテストレベル体系

| Level | 名称 | 対象 | 責任 | タイミング | 技法 |
|-------|------|------|------|-----------|------|
| L1 | Unit | 関数/メソッド | Dev | 毎コミット | 同値分割, BVA |
| L2 | Component | UI コンポーネント | Dev | 毎コミット | スナップショット |
| L3 | Integration | API/DB 連携 | Dev | PR 前 | 決定表 |
| L4 | System | サブシステム全体 | QA | リリース前 | 状態遷移 |
| L5 | E2E | ユーザーフロー | QA | リリース前 | シナリオベース |
| L6 | Acceptance | ビジネス要件 | PO | リリース前 | AC ベース |

### 4.3 ワークフロー改善案

```
┌─────────────────────────────────────────────────────────────────────┐
│ Phase 1: Spec 作成（現状維持）                                       │
├─────────────────────────────────────────────────────────────────────┤
│ Entry → QA → Spec → Multi-Review → SPEC GATE → [HUMAN_CHECKPOINT]    │
└─────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│ Phase 2: テスト設計 ★新規★                                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  2.1 Test Strategy 詳細化                                            │
│      - テストピラミッドに基づくカバレッジ目標設定                    │
│      - 各レベルの責任範囲定義                                        │
│                                                                      │
│  2.2 Test Case Design（テスト設計技法適用）                          │
│      ┌────────────────────────────────────────────────────────┐      │
│      │ L1 Unit: 同値分割・境界値分析によるケース設計          │      │
│      │ L2 Component: 状態別テストケース設計                    │      │
│      │ L3 Integration: API 契約に基づくテストケース            │      │
│      │ L5 E2E: UC フローベースのシナリオ                       │      │
│      └────────────────────────────────────────────────────────┘      │
│                                                                      │
│  2.3 Edge Case 体系的抽出                                            │
│      - 境界値一覧                                                    │
│      - 異常系パターン                                                │
│      - 並行処理/タイミング問題                                       │
│                                                                      │
│  2.4 Test Data 設計                                                  │
│      - テストフィクスチャ定義                                        │
│      - モック/スタブ戦略                                             │
│                                                                      │
│  Output: test-design.md（新規テンプレート）                          │
│  [HUMAN_CHECKPOINT] テスト設計レビュー                                │
└─────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│ Phase 3: Plan 作成（テスト設計参照追加）                              │
├─────────────────────────────────────────────────────────────────────┤
│ Plan 作成（Section 5 は test-design.md を参照）                       │
│ [HUMAN_CHECKPOINT]                                                   │
└─────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│ Phase 4: TDD 実装                                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  Tasks 分割（テストタスクを明示的に含める）                          │
│                                                                      │
│  for each task:                                                      │
│    ┌────────────────────────────────────────────────────────────┐    │
│    │ 4.1 Red: テストコード記述                                  │    │
│    │     - test-design.md のケースを実装                       │    │
│    │     - テストが失敗することを確認                          │    │
│    │                                                            │    │
│    │ 4.2 Green: プロダクトコード実装                           │    │
│    │     - テストをパスする最小限の実装                        │    │
│    │                                                            │    │
│    │ 4.3 Refactor: リファクタリング                            │    │
│    │     - テストが通ったままコード品質向上                    │    │
│    │                                                            │    │
│    │ 4.4 Coverage Check                                         │    │
│    │     - 目標カバレッジ達成確認                              │    │
│    └────────────────────────────────────────────────────────────┘    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│ Phase 5: 検証                                                        │
├─────────────────────────────────────────────────────────────────────┤
│  5.1 全テスト実行（Unit → Component → Integration → E2E）           │
│  5.2 カバレッジレポート確認                                          │
│  5.3 回帰テスト実行（既存機能への影響確認）                          │
│  5.4 [HUMAN_CHECKPOINT] テスト結果確認                                │
│  5.5 PR 作成                                                         │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.4 Before/After 比較

**Before:**
```
Spec → Plan → Tasks → Implement → Test-Scenario → E2E → PR
                                        ↑
                                  テスト設計は後
```

**After:**
```
Spec → Test-Design → Plan → Tasks → TDD-Implement → Verification → PR
            ↑                             ↑
      テスト設計が先               Red-Green-Refactor
```

---

## 5. Test Scope Hierarchy

### 5.1 テストスコープ階層

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Test Scope Hierarchy                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  L0: Foundation (基盤)                                               │
│  │   Scope: プロジェクト全体で共有                                   │
│  │   Owner: Foundation Spec / 基盤チーム                             │
│  │   Tests:                                                          │
│  │     - 共通ユーティリティの Unit テスト                            │
│  │     - フレームワーク設定のテスト                                  │
│  │     - 認証/認可の基盤テスト                                       │
│  │                                                                   │
│  L1: Domain (ドメイン)                                               │
│  │   Scope: Domain Spec で定義された M-*/API-*/BR-*                  │
│  │   Owner: Domain Spec / アーキテクト                               │
│  │   Tests:                                                          │
│  │     - Master データのバリデーションテスト                         │
│  │     - API 契約テスト (Contract Testing)                           │
│  │     - ビジネスルールの Unit テスト                                │
│  │                                                                   │
│  L2: Feature (機能)                                                  │
│  │   Scope: Feature Spec で定義された UC/FR                          │
│  │   Owner: Feature Spec / 開発チーム                                │
│  │   Tests:                                                          │
│  │     - Feature 固有ロジックの Unit テスト                          │
│  │     - Feature の Integration テスト                               │
│  │     - Feature の E2E テスト                                       │
│  │                                                                   │
│  L3: Cross-Feature (機能横断)                                        │
│      Scope: 複数 Feature を横断するフロー                            │
│      Owner: プロジェクト / QA                                        │
│      Tests:                                                          │
│        - ユーザージャーニーテスト                                    │
│        - 回帰テストスイート                                          │
│        - Smoke テスト                                                │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.2 テストの配置構造

```
.specify/
├── specs/
│   ├── overview/
│   │   ├── foundation/
│   │   │   ├── spec.md
│   │   │   └── test-design.md        ← L0: Foundation テスト設計
│   │   ├── domain/
│   │   │   ├── spec.md
│   │   │   └── test-design.md        ← L1: Domain テスト設計
│   │   └── screen/
│   │       └── spec.md
│   ├── features/
│   │   ├── S-AUTH-001/
│   │   │   ├── spec.md
│   │   │   ├── test-design.md        ← L2: Feature テスト設計
│   │   │   └── plan.md
│   │   └── S-ORDERS-001/
│   │       ├── spec.md
│   │       ├── test-design.md        ← L2: Feature テスト設計
│   │       └── plan.md
│   └── cross-feature/                 ← L3: 機能横断テスト（新規）
│       ├── journeys/
│       │   └── checkout-flow.md      ← ユーザージャーニー
│       ├── regression/
│       │   └── regression-suite.md   ← 回帰テストスイート
│       └── smoke/
│           └── smoke-suite.md        ← Smoke テスト
```

### 5.3 テストの責任分担

| Level | Spec Owner | Test Design | Test Implementation |
|-------|------------|-------------|---------------------|
| Foundation | Foundation Spec | Architect | Dev Team |
| Domain | Domain Spec | Architect | Dev Team |
| Feature | Feature Spec | Feature Dev | Feature Dev |
| Cross-Feature | (なし) | QA / Tech Lead | QA / Dev Team |

### 5.4 テスト変更時の責任

| 変更対象 | 影響範囲確認 | テスト更新責任 |
|----------|-------------|---------------|
| 共通ユーティリティ | 全 Feature | Foundation 担当 |
| Domain Master (M-*) | 参照する Feature | Domain 担当 + 各 Feature |
| Domain API (API-*) | 呼び出す Feature | Domain 担当 + 各 Feature |
| Feature 固有コード | その Feature のみ | Feature 担当 |

---

## 6. Feature Sizing Guidelines

### 6.1 Feature サイズの判断基準

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Feature Size Guidelines                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ◆ 適切な Feature のサイズ                                           │
│  ├── 実装期間: 1-3 週間                                              │
│  ├── ユースケース数: 2-5 個                                          │
│  ├── 画面数: 1-3 画面                                                │
│  ├── API エンドポイント: 2-7 個                                      │
│  └── テストケース目安:                                               │
│      ├── Unit: 10-30 件                                              │
│      ├── Integration: 3-10 件                                        │
│      └── E2E: 1-5 件                                                 │
│                                                                      │
│  ◆ Feature を分割すべきサイン                                        │
│  ├── [ ] UC が 7 個以上ある                                          │
│  ├── [ ] 実装見積もりが 1 ヶ月以上                                   │
│  ├── [ ] 複数の独立したユーザー価値がある                            │
│  ├── [ ] 異なるアクターが主体の UC が混在                            │
│  ├── [ ] テストケースが 50 個以上になりそう                          │
│  └── [ ] 一部だけ先にリリースしたい                                  │
│                                                                      │
│  ◆ Feature を統合すべきサイン                                        │
│  ├── [ ] 他の Feature なしでは意味をなさない                         │
│  ├── [ ] 常にセットで変更される                                      │
│  ├── [ ] テストが高度に重複する                                      │
│  ├── [ ] 同じ画面内の密結合した機能                                  │
│  └── [ ] 単独では 3 日以内で終わる小さな変更                         │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 6.2 Feature 粒度とテスト戦略のマトリックス

| Feature サイズ | Unit テスト | Integration テスト | E2E テスト | 判断 |
|---------------|-------------|-------------------|------------|------|
| **Micro** (< 1週間) | 5-10 件 | 1-3 件 | 0-1 件 | 統合検討 |
| **Small** (1-2週間) | 10-20 件 | 3-5 件 | 1-3 件 | 理想的 |
| **Medium** (2-3週間) | 20-30 件 | 5-10 件 | 3-5 件 | 理想的 |
| **Large** (> 3週間) | 30+ 件 | 10+ 件 | 5+ 件 | 分割検討 |

---

## 7. Test Execution Pipeline

### 7.1 CI/CD パイプラインでのテスト実行

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Test Execution Pipeline                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  Stage 1: Pre-commit (ローカル)                                      │
│  ├── 変更ファイルに関連する Unit テストのみ                          │
│  ├── Lint / Format チェック                                          │
│  └── 目標: < 30 秒                                                   │
│                                                                      │
│  Stage 2: PR Creation                                                │
│  ├── 変更 Feature の全 Unit テスト                                   │
│  ├── 変更 Feature の Integration テスト                              │
│  ├── 影響を受ける Feature のテスト (Impact Analysis)                 │
│  └── 目標: < 5 分                                                    │
│                                                                      │
│  Stage 3: PR Merge (main へ)                                         │
│  ├── 全 Foundation テスト                                            │
│  ├── 全 Domain テスト                                                │
│  ├── 全 Feature Unit/Integration テスト                              │
│  ├── Smoke E2E テスト                                                │
│  └── 目標: < 15 分                                                   │
│                                                                      │
│  Stage 4: Pre-Deploy (Staging)                                       │
│  ├── 全テストスイート                                                │
│  ├── 全 E2E テスト                                                   │
│  ├── パフォーマンステスト                                            │
│  └── 目標: < 30 分                                                   │
│                                                                      │
│  Stage 5: Post-Deploy (Production)                                   │
│  ├── Smoke テスト                                                    │
│  ├── ヘルスチェック                                                  │
│  └── 目標: < 5 分                                                    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 7.2 Feature 変更時の影響分析

```
Feature A を変更
      │
      ▼
┌─────────────────────────────────────────────────────────────────────┐
│ Impact Analysis                                                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  1. 直接影響                                                         │
│     └── Feature A 自身のテスト → 全実行                              │
│                                                                      │
│  2. Domain 影響（M-*/API-* を変更した場合）                          │
│     ├── Domain テスト → 該当部分実行                                 │
│     └── 参照する他 Feature → Integration テスト実行                  │
│                                                                      │
│  3. 依存影響（Feature A に依存する Feature）                         │
│     └── Feature B, C → Smoke テスト実行                              │
│                                                                      │
│  4. 横断影響（Cross-Feature フロー）                                 │
│     └── Feature A を含むジャーニー → E2E テスト実行                  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 8. Coverage Standards (Proposed)

### 8.1 カバレッジ基準

| Level | Metric | Target | Enforcement |
|-------|--------|--------|-------------|
| Unit | Line Coverage | >= 80% | CI/CD Gate |
| Unit | Branch Coverage | >= 70% | CI/CD Gate |
| Integration | API Endpoint | 100% | PR Review |
| E2E | UC Coverage | 100% | QA Check |

### 8.2 回帰テスト戦略

| Suite | 実行タイミング | 範囲 | 目標時間 |
|-------|---------------|------|---------|
| Smoke | 毎デプロイ前 | 主要機能のみ | < 5 分 |
| Regression | 週次 or 大規模変更時 | 全機能 | < 30 分 |
| Full | リリース前 | 全テスト | < 60 分 |

### 8.3 非機能テスト

| Type | When | Criteria | Tool |
|------|------|----------|------|
| Performance | リリース前 | 応答時間 < 200ms | k6/Artillery |
| Load | リリース前 | 同時100ユーザー | k6 |
| Security | リリース前 | OWASP Top 10 | OWASP ZAP |

---

## 9. Implementation Roadmap

### 9.1 優先度順の改善項目

| 優先度 | 改善項目 | 理由 | 見積工数 |
|--------|---------|------|---------|
| **★P0★** | **Requirements Analysis フェーズの追加** | **根本原因の解決** | 2-3日 |
| **★P0★** | **requirements-analysis.md テンプレート作成** | **パターン網羅の基盤** | 1日 |
| **P1** | Test Design フェーズの追加 | TDD の本質 | 2-3日 |
| **P1** | test-design.md テンプレート作成 | 体系的テスト設計 | 1日 |
| **P1** | ワークフロー順序変更 | Input → Analysis → QA → Spec → Test Design → Plan | 1日 |
| **P2** | テスト設計技法のガイド作成 | 同値分割/BVA等 | 2日 |
| **P2** | カバレッジ基準の Constitution 追加 | 品質担保 | 0.5日 |
| **P2** | Cross-Feature テスト構造の追加 | 機能横断テスト | 1日 |
| **P3** | 非機能テストワークフロー追加 | 性能/セキュリティ | 2日 |
| **P3** | 回帰テスト戦略の明文化 | 品質維持 | 1日 |

### 9.2 段階的導入計画

**Phase 0: 要件分析基盤 (Week 0-1) ★最優先★**
- requirements-analysis.md テンプレート作成 ✅ 完了
- 要件分析ワークフロー設計
- QA の役割再定義（質問 → 分析確認）

**Phase 1: 基盤整備 (Week 1-2)**
- test-design.md テンプレート作成 ✅ 完了
- ワークフロー順序変更
- Feature Sizing ガイドライン追加 ✅ 完了

**Phase 2: テスト設計強化 (Week 3-4)**
- テスト設計技法ガイド作成
- エッジケースチェックリスト整備
- カバレッジ基準の Constitution 追加

**Phase 3: 横断テスト (Week 5-6)**
- Cross-Feature テスト構造の追加 ✅ 完了
- ユーザージャーニーテスト設計
- 回帰テストスイート整備

**Phase 4: 非機能テスト (Week 7-8)**
- パフォーマンステストワークフロー
- セキュリティテストワークフロー
- CI/CD パイプライン統合

### 9.3 完了済みアイテム

| アイテム | ファイル | 状態 |
|---------|---------|------|
| requirements-analysis.md テンプレート | `templates/requirements-analysis.md` | ✅ |
| test-design.md テンプレート | `templates/test-design.md` | ✅ |
| Feature Sizing ガイドライン | `guides/feature-sizing.md` | ✅ |
| Cross-Feature テストガイド | `guides/cross-feature-testing.md` | ✅ |

---

## 10. Appendix

### 10.1 Related Documents

**作成済み:**
- [requirements-analysis.md](../templates/requirements-analysis.md) - 要件分析テンプレート ✅
- [test-design.md](../templates/test-design.md) - テスト設計テンプレート ✅
- [feature-sizing.md](../guides/feature-sizing.md) - Feature サイズガイドライン ✅
- [cross-feature-testing.md](../guides/cross-feature-testing.md) - 機能横断テストガイド ✅

**作成予定:**
- test-techniques-guide.md - テスト設計技法ガイド
- requirements-analysis-workflow.md - 要件分析ワークフロー

### 10.2 References

- Kent Beck, "Test-Driven Development: By Example"
- ISTQB Foundation Level Syllabus
- Martin Fowler, "TestPyramid" (https://martinfowler.com/bliki/TestPyramid.html)
- IEEE 829 - Software Test Documentation
- Karl Wiegers, "Software Requirements" (要件分析技法)

---

## Changelog

| Date | Version | Change | Author |
|------|---------|--------|--------|
| 2026-01-06 | 1.0.0 | Initial proposal | AI Assistant |
| 2026-01-06 | 1.1.0 | Added Requirements Analysis phase as root cause solution | AI Assistant |
