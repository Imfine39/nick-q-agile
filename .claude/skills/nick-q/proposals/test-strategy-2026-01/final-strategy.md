# テスト戦略改善提案 - 最終版

Status: **Proposal - Final**
Created: 2026-01-06
Version: 3.0.0

---

## Executive Summary

テストの問題は「テスト」だけの問題ではない。
上流（Feature のアイディア出し）から下流（実行）まで、すべてのレイヤーに原因がある。

### 核心的な方針

| 原則 | 説明 |
|------|------|
| **責任の移動** | チェック操作は AI ではなくツールが担う |
| **上流で防ぐ** | Feature の粒度を入口でチェック |
| **シンプルに保つ** | 複雑なルール（Level判定等）は不要 |
| **柔軟に判断** | 「複雑なら DT」程度の判断でいい |

---

## 1. 問題の全体像

```
┌─────────────────────────────────────────────────────────────────────┐
│ Layer 0: アイディア（最上流）                                        │
├─────────────────────────────────────────────────────────────────────┤
│ 問題: Feature の粒度が大きすぎる / 複数責務が混在                   │
│ 結果: 条件分岐爆発、テストケース膨大                                │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│ Layer 1: 設計                                                        │
├─────────────────────────────────────────────────────────────────────┤
│ 問題: Feature 分割の指針がない                                      │
│ 結果: 適切な粒度が分からない                                        │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│ Layer 2: 分析                                                        │
├─────────────────────────────────────────────────────────────────────┤
│ 問題: QA が「穴埋め質問」になっている                               │
│ 結果: パターン分析不足、エッジケース漏れ                            │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│ Layer 3: 実行                                                        │
├─────────────────────────────────────────────────────────────────────┤
│ 問題: AI がチェックを忘れる                                         │
│ 結果: 状態不整合、進捗不明                                          │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. 解決策

### 2.1 Layer 0: Feature アイディア評価

```
【フロー】

ユーザー: 「〇〇機能を作りたい」
    ↓
粒度チェック:
    ├── 単一の価値提供か？
    ├── 1-2週間で完了できるか？
    ├── 条件分岐は 5-7 個以下か？
    └── テストの境界が明確か？
    ↓
    ├─ 適切 → そのまま進む
    └─ 大きすぎる → 分割提案


【分割すべきサイン】

• 「〇〇と△△ができる」（「と」で繋がる = 複数責務）
• ユースケース 5 個以上
• 条件分岐 8 個以上
• 「管理機能」「〇〇システム」という命名
• 異なるアクターが関わる


【分割の方法】

• 責務で分割: 「ユーザー管理」→「登録」「認証」「編集」
• アクターで分割: 「注文管理」→「顧客の注文」「管理者の注文管理」
• 状態で分割: 「注文処理」→「作成」「支払い」「発送」「完了」
• CRUD で分割: 「商品」→「登録」「一覧」「編集」「削除」
```

### 2.2 Layer 1: 設計（project-setup）

```
【project-setup に追加】

1. Feature 分割ガイドライン
   • 1 Feature = 単一の価値提供
   • 1 Feature = 1-2 週間で完了
   • 条件分岐は 5-7 個以下を目安
   • テスト可能な境界を持つ

2. テスト戦略の概要
   • 境界値とパターンは常に考える
   • DT は複雑な時だけ
   • E2E の範囲
```

### 2.3 Layer 2: 分析（QA 拡張）

```
【QA に追加するもの】

常に実施:
├── 境界値リスト
│   • 各入力の最小/最大/典型/超過
│   • 5分で書ける
│
└── 主要パターン（5-10個）
    • ハッピーパス
    • 主要な異常系
    • エッジケース

複雑な場合のみ（柔軟に判断）:
├── ディシジョンテーブル
│   • 条件分岐が複雑と感じたら
│   • 厳密な基準は不要
│
└── 状態遷移図
    • 状態があると感じたら


【重要】
Level 判定のような複雑なルールは不要
「必要そうなら作る」でいい
```

### 2.4 Layer 3: 実行（Task 追跡自動化）

```
【責任の移動】

Before:
  AI がコードを書く → AI がチェックを入れる（忘れる）

After:
  AI がコードを書く → AI がコミット → hooks が自動でチェック


【実装】

1. Claude Code PostToolUse hook
   • Bash(git commit) 実行後に発火
   • コミットメッセージからタスク ID 抽出
   • tasks.md 自動更新

2. コミットメッセージ規約
   feat: add user auth [T-001]

3. AI の責任
   • コードを書く
   • テストを書く
   • コミットする（タスクID含める）
   • 以上！（チェック操作は不要）
```

---

## 3. ワークフローの変化

```
【現行】
Input → QA → Spec → Plan → Tasks → Implement → E2E

【改善後】
Input → 粒度チェック → QA+ → Spec → Plan → Tasks → Implement+ → E2E
        ^^^^^^^^^^^    ^^^                      ^^^^^^^^^^
        分割判断       パターン分析              自動追跡
```

---

## 4. 整合性チェック（spec-lsp）

### 4.1 ツール

```
spec-lsp.cjs

コマンド:
  refs <element>      # M-User, API-XXX の参照一覧
  impact <element>    # 変更時の影響分析
  unused              # 未使用の Domain 要素
  validate            # Spec と実装の整合性チェック
```

### 4.2 呼び出しタイミング

```
【ワークフローの要所で自動呼び出し】

1. Feature Spec 作成時（feature.md）
   → 使用する Domain を自動抽出・表示
   → 「M-User, API-Auth を使用します」

2. implement 開始時（implement.md）
   → spec-lsp refs で関連定義を表示
   → 「M-Role の定義: ROLE_USER, ROLE_ADMIN...」
   → モックデータ等の実装ミスを防ぐ

3. PR/E2E 前（検証）
   → spec-lsp validate
   → 「不整合があります」or「OK」

※ 毎 Task ではなく、要所で呼ぶ
```

---

## 5. 変更が必要なファイル

| ファイル | 変更内容 | 優先度 |
|----------|----------|--------|
| `scripts/spec-lsp.cjs` | 新規作成（refs/impact/validate） | P0 |
| `scripts/task-complete.cjs` | 新規作成（list/pending/complete/stats） | P1 |
| `.claude/hooks/post-commit-task.cjs` | Claude Code hooks（自動追跡） | P1 |
| `workflows/feature.md` | spec-lsp 呼び出し追加 | P2 |
| `workflows/implement.md` | spec-lsp refs 呼び出し追加 | P2 |
| `SKILL.md` | Feature 粒度チェック追加 | P2 |
| `templates/qa.md` | パターン分析セクション | P3 |
| `workflows/qa.md` | パターン分析ステップ | P3 |
| `workflows/project-setup.md` | ガイドライン追加 | P4 |

---

## 6. 実装優先度

```
Priority 0: spec-lsp.cjs（整合性の基盤）★最優先
├── refs/impact/validate コマンド
├── 実装ミス（モックデータ等）を防ぐ
└── ワークフローの要所で呼び出し

Priority 1: Task 追跡自動化
├── 他に依存しない
├── 即効性がある
└── チェック漏れ問題を根本解決

Priority 2: Feature 粒度チェック + ワークフロー統合
├── 上流で問題を防ぐ
├── feature.md に spec-lsp 呼び出し追加
└── implement.md に spec-lsp refs 追加

Priority 3: QA パターン分析
├── エッジケース漏れを防ぐ
└── 適切な粒度の Feature に対して効果的

Priority 4: project-setup 拡張
├── 長期的な品質向上
└── 新規プロジェクトから適用
```

---

## 7. 成功基準

| 指標 | 現状 | 目標 |
|------|------|------|
| 実装ミス（仕様との不整合） | 頻発 | 0 |
| チェック漏れ率 | 高 | < 5% |
| エッジケース漏れ | 頻発 | 重大なもの 0 |
| Feature 分割提案率 | 0% | 大きい要求の 80% |
| AI のチェック操作 | 頻繁 | 0 |

---

## 8. 却下した案

| 案 | 却下理由 |
|----|----------|
| Requirements Analysis 新規フェーズ | 複雑化、QA 拡張で十分 |
| Test Design 新規フェーズ | 複雑化、Plan 拡張で十分 |
| Rigor Level 判定 | 過剰設計、柔軟な判断で十分 |
| 367行のテンプレート | 形骸化する、軽量に |

---

## 9. 関連ドキュメント

本 proposals ディレクトリ内:

| ファイル | 内容 |
|----------|------|
| `task-tracking-automation.md` | Task 追跡自動化の詳細設計 |
| `qa-enhancement.md` | QA 拡張の詳細 |
| `graduated-rigor.md` | Rigor Level（参考、採用しない） |
| `supplementary-testing.md` | テストデータ・非機能要件 |
| `lightweight-templates/` | 軽量化テンプレート |
| `agile-design-proposal.md` | アジャイル設計の検討（別提案） |

---

## Changelog

| Date | Version | Change |
|------|---------|--------|
| 2026-01-06 | 1.0.0 | v1.x 初期提案 |
| 2026-01-06 | 2.0.0 | 批判的再検討、責任の移動 |
| 2026-01-06 | 3.0.0 | Level判定却下、Feature粒度追加、最終化 |
| 2026-01-06 | 3.1.0 | spec-lsp 追加（P0）、呼び出しタイミング定義 |
