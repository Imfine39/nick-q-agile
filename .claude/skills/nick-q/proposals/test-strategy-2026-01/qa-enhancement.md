# QA Enhancement Proposal

Status: **Proposal**
Phase: **1**
Created: 2026-01-06

---

## 1. 概要

### 1.1 提案の要点

```
【現状】
QA = 質問による要件確認（穴埋め式）

【提案】
QA+ = 質問 + パターン分析（Rigor Level に応じて）

追加されるもの:
├── Level 1: なし（従来通り）
├── Level 2: 境界値リスト + 主要パターン
└── Level 3: ディシジョンテーブル + 状態遷移図
```

### 1.2 なぜ新規フェーズではなく QA 拡張か

```
┌─────────────────────────────────────────────────────────────────────┐
│ 新規フェーズ追加 vs QA 拡張                                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 【新規フェーズ追加の問題】                                           │
│ • ワークフローが複雑化（7ステップ → 8ステップ）                     │
│ • 学習コストが増加                                                   │
│ • 既存プロジェクトへの適用が大変                                    │
│ • フェーズ間の重複（QA と Requirements Analysis）                   │
│                                                                      │
│ 【QA 拡張の利点】                                                    │
│ • ワークフロー変更なし（7ステップ維持）                             │
│ • 既存の QA 知識を活用                                               │
│ • 段階的に厳格化可能                                                │
│ • Rigor Level で柔軟に調整                                          │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. QA+ の設計

### 2.1 拡張後の QA 構造

```
QA+ (Enhanced QA)
│
├── Step 1: Rigor Level 判定
│   └── ビジネスインパクト、複雑度などから Level 1/2/3 を決定
│
├── Step 2: 従来の QA（全 Level 共通）
│   └── 質問による要件確認
│
├── Step 3: パターン分析（Level 2/3）
│   ├── Level 2: 境界値 + 主要パターン
│   └── Level 3: DT + 状態遷移 + 同値分割
│
└── Step 4: 分析結果の QA ドキュメント統合
```

### 2.2 Rigor Level 判定フロー

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Rigor Level 判定                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   START                                                              │
│     │                                                                │
│     ▼                                                                │
│   ┌─────────────────────────────┐                                    │
│   │ 金銭的影響が直接的か？       │                                   │
│   └─────────────┬───────────────┘                                    │
│                 │                                                    │
│       Yes ──────┼────────────────────────────────→ Level 3           │
│                 │ No                                                 │
│                 ▼                                                    │
│   ┌─────────────────────────────┐                                    │
│   │ 認証/認可/セキュリティ関連か？│                                   │
│   └─────────────┬───────────────┘                                    │
│                 │                                                    │
│       Yes ──────┼────────────────────────────────→ Level 3           │
│                 │ No                                                 │
│                 ▼                                                    │
│   ┌─────────────────────────────┐                                    │
│   │ 条件分岐が 8 個以上か？      │                                    │
│   └─────────────┬───────────────┘                                    │
│                 │                                                    │
│       Yes ──────┼────────────────────────────────→ Level 3           │
│                 │ No                                                 │
│                 ▼                                                    │
│   ┌─────────────────────────────┐                                    │
│   │ 状態が 5 個以上か？          │                                    │
│   └─────────────┬───────────────┘                                    │
│                 │                                                    │
│       Yes ──────┼────────────────────────────────→ Level 3           │
│                 │ No                                                 │
│                 ▼                                                    │
│   ┌─────────────────────────────┐                                    │
│   │ MVP/プロトタイプ/実験的か？  │                                    │
│   └─────────────┬───────────────┘                                    │
│                 │                                                    │
│       Yes ──────┼────────────────────────────────→ Level 1           │
│                 │ No                                                 │
│                 ▼                                                    │
│              Level 2                                                 │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.3 Level 別の分析内容

```
┌─────────────────────────────────────────────────────────────────────┐
│ Level 1: Minimal（探索的・MVP）                                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ QA 項目: 5-10 問                                                     │
│ パターン分析: なし                                                   │
│                                                                      │
│ チェックリスト:                                                      │
│ □ 主要なユースケースは明確か                                        │
│ □ エラー時の挙動は定義されているか                                  │
│ □ 入力の基本的な検証ルールはあるか                                  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ Level 2: Standard（通常の機能）                                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ QA 項目: 10-20 問                                                    │
│ パターン分析:                                                        │
│   • 境界値リスト                                                     │
│   • 主要パターン（5-10 個）                                          │
│                                                                      │
│ 境界値リスト例:                                                      │
│ ┌──────────────┬─────────────────────────────────┐                   │
│ │ 入力項目      │ 境界値                          │                   │
│ ├──────────────┼─────────────────────────────────┤                   │
│ │ 名前          │ 空, 1文字, 50文字, 51文字       │                   │
│ │ メールアドレス│ 空, 無効形式, 有効形式, 重複    │                   │
│ │ 数量          │ 0, 1, 上限-1, 上限, 上限+1      │                   │
│ └──────────────┴─────────────────────────────────┘                   │
│                                                                      │
│ 主要パターン例:                                                      │
│ • 新規ユーザー登録（ハッピーパス）                                  │
│ • 既存メールで登録試行（エラー）                                    │
│ • 必須項目未入力（バリデーション）                                  │
│ • ...                                                                │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ Level 3: Rigorous（高リスク機能）                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ QA 項目: 20+ 問                                                      │
│ パターン分析:                                                        │
│   • ディシジョンテーブル                                            │
│   • 状態遷移図                                                       │
│   • 同値分割                                                         │
│   • 境界値分析（詳細）                                              │
│                                                                      │
│ ディシジョンテーブル例:                                             │
│ ┌─────────────────────────────────────────────────────────────┐     │
│ │ 条件                    │ R1 │ R2 │ R3 │ R4 │ R5 │ R6 │ R7 │ R8 │ │
│ ├─────────────────────────┼────┼────┼────┼────┼────┼────┼────┼────┤ │
│ │ ログイン済み             │ Y  │ Y  │ Y  │ Y  │ N  │ N  │ N  │ N  │ │
│ │ 商品在庫あり             │ Y  │ Y  │ N  │ N  │ Y  │ Y  │ N  │ N  │ │
│ │ 支払い方法有効           │ Y  │ N  │ Y  │ N  │ Y  │ N  │ Y  │ N  │ │
│ ├─────────────────────────┼────┼────┼────┼────┼────┼────┼────┼────┤ │
│ │ 購入成功                 │ ✓  │    │    │    │    │    │    │    │ │
│ │ 支払いエラー表示         │    │ ✓  │    │ ✓  │    │ ✓  │    │ ✓  │ │
│ │ 在庫切れエラー表示       │    │    │ ✓  │ ✓  │    │    │ ✓  │ ✓  │ │
│ │ ログイン画面へリダイレクト│    │    │    │    │ ✓  │ ✓  │ ✓  │ ✓  │ │
│ └─────────────────────────┴────┴────┴────┴────┴────┴────┴────┴────┘ │
│                                                                      │
│ 状態遷移図:                                                          │
│   [カート空] --商品追加--> [カートあり] --購入--> [決済中]          │
│       ^                        │                     │               │
│       │                        │                     │               │
│       +----商品削除(最後)------+     [完了] <--成功--+               │
│                                       [失敗] <--エラー-+             │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. QA ドキュメントテンプレート

### 3.1 Level 1 テンプレート（軽量）

```markdown
# QA: {Feature Title}

Rigor Level: **1 (Minimal)**
Feature ID: {id}
Date: {date}

---

## 1. 基本確認

### 1.1 ユースケース
- [ ] 主要なユースケースは何か
- [ ] 誰が使うか（ユーザー種別）
- [ ] いつ使うか（利用シーン）

### 1.2 入出力
- [ ] 必須の入力項目は何か
- [ ] 出力/結果は何か
- [ ] エラー時の挙動は何か

### 1.3 制約
- [ ] 技術的制約はあるか
- [ ] ビジネス制約はあるか

---

## 2. 回答

{回答をここに記載}

---

## 3. 確認事項

- [ ] すべての質問に回答した
- [ ] 不明点は [NEEDS CLARIFICATION] でマークした
```

### 3.2 Level 2 テンプレート（標準）

```markdown
# QA: {Feature Title}

Rigor Level: **2 (Standard)**
Feature ID: {id}
Date: {date}

---

## 1. 基本確認

{Level 1 と同じ}

## 2. 詳細確認

### 2.1 データ
- [ ] 入力データの検証ルールは何か
- [ ] データの永続化は必要か
- [ ] 既存データとの整合性は

### 2.2 フロー
- [ ] 正常フローの詳細は
- [ ] 異常フロー/エラーハンドリングは
- [ ] キャンセル/中断時の挙動は

### 2.3 境界条件
- [ ] 入力の最大/最小値は
- [ ] 同時実行の考慮は必要か
- [ ] タイムアウトの考慮は必要か

---

## 3. 回答

{回答をここに記載}

---

## 4. パターン分析

### 4.1 境界値リスト

| 入力項目 | 最小 | 最小+1 | 典型 | 最大-1 | 最大 | 超過 |
|----------|------|--------|------|--------|------|------|
| {項目1}  |      |        |      |        |      |      |
| {項目2}  |      |        |      |        |      |      |

### 4.2 主要パターン

| # | パターン名 | 条件 | 期待結果 | 優先度 |
|---|------------|------|----------|--------|
| 1 | ハッピーパス |      |          | 高     |
| 2 | {異常系1}  |      |          | 高     |
| 3 | {異常系2}  |      |          | 中     |

---

## 5. 確認事項

- [ ] すべての質問に回答した
- [ ] 境界値リストを作成した
- [ ] 主要パターンを 5-10 個特定した
- [ ] 不明点は [NEEDS CLARIFICATION] でマークした
```

### 3.3 Level 3 テンプレート（厳格）

```markdown
# QA: {Feature Title}

Rigor Level: **3 (Rigorous)**
Feature ID: {id}
Date: {date}

---

## 1. 基本確認

{Level 1 と同じ}

## 2. 詳細確認

{Level 2 と同じ}

## 3. 高度な確認

### 3.1 セキュリティ
- [ ] 認証/認可の要件は
- [ ] 入力のサニタイズは必要か
- [ ] 機密データの扱いは

### 3.2 整合性
- [ ] トランザクション境界は
- [ ] 失敗時のロールバックは
- [ ] 部分的成功の扱いは

### 3.3 監査
- [ ] ログ記録の要件は
- [ ] 監査証跡は必要か

---

## 4. 回答

{回答をここに記載}

---

## 5. パターン分析

### 5.1 境界値リスト

{Level 2 と同じ}

### 5.2 ディシジョンテーブル

#### 条件

| # | 条件 | 説明 |
|---|------|------|
| C1 | {条件1} | {説明} |
| C2 | {条件2} | {説明} |
| C3 | {条件3} | {説明} |

#### アクション

| # | アクション | 説明 |
|---|------------|------|
| A1 | {アクション1} | {説明} |
| A2 | {アクション2} | {説明} |
| A3 | {アクション3} | {説明} |

#### ルール

| 条件/アクション | R1 | R2 | R3 | R4 | R5 | R6 | R7 | R8 |
|-----------------|----|----|----|----|----|----|----|----|
| C1              | Y  | Y  | Y  | Y  | N  | N  | N  | N  |
| C2              | Y  | Y  | N  | N  | Y  | Y  | N  | N  |
| C3              | Y  | N  | Y  | N  | Y  | N  | Y  | N  |
| A1              |    |    |    |    |    |    |    |    |
| A2              |    |    |    |    |    |    |    |    |
| A3              |    |    |    |    |    |    |    |    |

### 5.3 状態遷移図

```
[状態A] --イベント1--> [状態B]
    ^                     |
    |                     |
    +---イベント2---------+
```

### 5.4 同値分割

| 入力項目 | 有効同値クラス | 無効同値クラス |
|----------|----------------|----------------|
| {項目1}  | {有効1}, {有効2} | {無効1}, {無効2} |
| {項目2}  | {有効1}        | {無効1}, {無効2}, {無効3} |

---

## 6. テストケース導出

### 6.1 ディシジョンテーブルからの導出

| TC# | 元ルール | テストケース名 | 優先度 |
|-----|----------|----------------|--------|
| TC001 | R1 | {テストケース名} | 高 |
| TC002 | R2 | {テストケース名} | 高 |

### 6.2 境界値からの導出

| TC# | 項目 | 値タイプ | テストケース名 | 優先度 |
|-----|------|----------|----------------|--------|
| TC010 | {項目} | 最小 | {テストケース名} | 中 |
| TC011 | {項目} | 最大 | {テストケース名} | 中 |

---

## 7. 確認事項

- [ ] すべての質問に回答した
- [ ] ディシジョンテーブルを作成した
- [ ] 状態遷移図を作成した（状態がある場合）
- [ ] 同値分割を行った
- [ ] テストケースを導出した
- [ ] 不明点は [NEEDS CLARIFICATION] でマークした
```

---

## 4. ワークフロー変更

### 4.1 既存 QA ワークフローへの追加

```
【現行の qa.md フロー】
1. QA テンプレート生成
2. 質問への回答収集
3. 不明点の clarify
4. QA ドキュメント完成

【追加するステップ】
0. Rigor Level 判定        ← NEW
1. QA テンプレート生成（Level に応じて選択）
2. 質問への回答収集
3. パターン分析実施（Level 2/3）  ← NEW
4. 不明点の clarify
5. QA ドキュメント完成
```

### 4.2 qa.md への変更案

```markdown
## Step 0: Rigor Level 判定

以下の基準で Level を判定:

| 条件 | 結果 |
|------|------|
| 金銭的影響が直接的 | Level 3 |
| 認証/認可/セキュリティ関連 | Level 3 |
| 条件分岐 8 個以上 | Level 3 |
| 状態 5 個以上 | Level 3 |
| MVP/プロトタイプ/実験的 | Level 1 |
| 上記以外 | Level 2 |

判定結果を Feature Spec の metadata に記録:
  rigor_level: {1|2|3}
```

---

## 5. Spec への反映

### 5.1 Feature Spec テンプレートへの追加

```markdown
## Metadata

- Feature ID: {id}
- Rigor Level: {1|2|3}  ← NEW
- QA Status: {draft|completed}

## Analysis Summary (Level 2/3)  ← NEW

### 境界値
{QA から転記}

### 主要パターン
{QA から転記}

### ディシジョンテーブル (Level 3)
{QA から転記}

### 状態遷移 (Level 3)
{QA から転記}
```

---

## 6. 実装計画

### Phase 1.1: テンプレート作成（即座）

```
作成物:
├── templates/qa-level1.md
├── templates/qa-level2.md
└── templates/qa-level3.md
```

### Phase 1.2: ワークフロー更新（その後）

```
修正:
├── workflows/qa.md（Rigor Level 判定追加）
└── templates/feature-spec.md（Analysis Summary 追加）
```

### Phase 1.3: Lint 追加（最後）

```
追加:
└── spec-lint.cjs に Level 別の検証ルール
    - Level 2: 境界値リスト必須
    - Level 3: DT + 状態遷移必須
```

---

## 7. Success Criteria

| 指標 | 目標 |
|------|------|
| エッジケース漏れ（Level 3 機能） | 0 |
| 分析コスト（Level 1） | 現状維持 |
| 分析コスト（Level 2） | +30% 以内 |
| テンプレート行数（Level 1） | < 50 行 |
| テンプレート行数（Level 2） | < 100 行 |

---

## Changelog

| Date | Version | Change |
|------|---------|--------|
| 2026-01-06 | 1.0.0 | Initial proposal |
